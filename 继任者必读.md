# 继任者必读（百姓助手）

> 用途：当你接手本项目时，优先看这份文档了解“当前做到哪、怎么跑起来、下一步做什么”。

## 0. 当前开发状态（结论）

- **本次会话在推进第十六阶段 P2.1「AI 初诊 + 律师复核」**。
- **P2.1 已形成最小闭环**：后端（模型/路由/支付接入/结算接入/迁移）+ 前端接入 + 回归测试均已完成。
- **第十八阶段补充**：已落地 **A/B 与 Prompt 版本化**（灰度选 `prompt_version`、`references.meta` 透传与持久化、管理端按 `prompt_version` 聚合反馈统计）。

## 1. P2.1 目标与最小闭环

目标闭环（验收口径）：

- 用户完成 AI 咨询后，可为某次咨询购买「律师复核」服务
- 支付成功后生成一条复核任务
- 律师在工作台领取任务、编辑并提交复核稿（Markdown）
- 用户端能看到“已复核”结果
- 提交复核后，自动生成结算收入记录（复用 `settlement` 体系）

## 2. 已落地的后端实现（重要）

### 2.1 数据表/模型

新增文件：

- `backend/app/models/consultation_review.py`

新增模型：

- `ConsultationReviewTask`
  - 关键字段：
    - `consultation_id`：关联 `consultations.id`（AI 咨询会话）
    - `user_id`：购买者（咨询 owner）
    - `order_id/order_no`：关联支付订单（**唯一约束 `order_id` 防重入**）
    - `status`：`pending` → `claimed` → `submitted`
    - `lawyer_id`：领取任务的律师
    - `result_markdown`：最终复核稿
    - `claimed_at/submitted_at`
- `ConsultationReviewVersion`
  - 每次提交生成一条版本记录（审计/追溯）
  - 字段：`task_id/editor_user_id/editor_role/content_markdown/created_at`

模型导出/注册：

- `backend/app/models/__init__.py` 已加入 `ConsultationReviewTask/ConsultationReviewVersion`
- `backend/app/database.py:init_db()` 已加入 `app.models.consultation_review`（便于 debug runtime ddl / 本地 create_all）

### 2.2 Alembic 迁移

新增迁移：

- `backend/alembic/versions/d4f2c9a31b10_add_consultation_review_tables.py`
  - 创建两张表 + 索引
  - `down_revision = "c3a4d1e7f9ab"`

如果你在本地/生产 `DEBUG=false`，启动会触发 `init_db` 的 alembic head 检查：

- 需要执行：
  - `py scripts/alembic_cmd.py upgrade head`

### 2.3 API 路由

新增路由文件：

- `backend/app/routers/reviews.py`

已挂载到总路由：

- `backend/app/routers/__init__.py`：`api_router.include_router(reviews.router)`

当前接口（均在 `/api` 下）：

- `GET /reviews/consultations/{consultation_id}`
  - 用户查询某次 AI 咨询对应的复核任务（若无则返回 `task=null`）
- `GET /reviews/lawyer/tasks?status=`
  - 律师获取任务列表（当前逻辑：可看到“未领取任务”或“已分配给自己”的任务）
- `POST /reviews/lawyer/tasks/{task_id}/claim`
  - 领取任务：仅允许 `status=pending` 且 `lawyer_id is null`
- `POST /reviews/lawyer/tasks/{task_id}/submit`
  - 提交复核：仅允许领取者提交
  - 写入 `ConsultationReviewVersion`
  - 更新 `ConsultationReviewTask.result_markdown/status/submitted_at`
  - 调用结算服务生成 `LawyerIncomeRecord`

权限：

- 律师端接口使用 `require_lawyer_verified`（登录 + 律师角色 + 手机/邮箱验证）
- 额外在 `reviews.py` 中检查 `Lawyer.is_verified == True`，避免“律师用户但未通过律师认证”误操作

### 2.4 支付订单类型接入

修改文件：

- `backend/app/routers/payment.py`
- `backend/app/models/payment.py`

补充：合同审查模块（已存在，便于后续扩展/验收定位）：

- 后端路由：`backend/app/routers/contracts.py`
  - 入口：`POST /api/contracts/review`
  - 说明：上传合同（PDF/Word）-> 文本提取 -> PII 脱敏 -> 调用 AI 生成审查报告
- 前端页面：`frontend/src/pages/ContractReviewPage.tsx`
  - 路由：`/contracts`

补充：支付渠道状态与管理端密钥维护（便于联调/排障）：

- 公共渠道状态：`GET /api/payment/channel-status`（不含敏感信息；前端用于动态显示可用支付方式）
- 管理端密钥维护（env 热更新）：
  - 入口页面：`/admin/payment-callbacks`
  - 后端实现：`backend/app/routers/payment.py`（会更新当前 ENV_FILE 指向的 env 文件中的白名单字段）

新增订单类型：

- `order_type = light_consult_review`
- 价格：
  - Env fallback：`LIGHT_CONSULT_REVIEW_DEFAULT_PRICE`（默认 19.9）
  - SystemConfig 可覆盖：`LIGHT_CONSULT_REVIEW_PRICE`

下单校验：

- `POST /api/payment/orders` 支持 `order_type=light_consult_review`
- `related_type` 强制为 `ai_consultation`
- `related_id` 必须为咨询 `consultations.id` 且必须属于当前用户

支付后自动生成任务：

- 通过 hook：`_maybe_create_consultation_review_task_in_tx(db, order)`
- 在两条路径触发：
  - 余额支付成功（`pay_order` 内）
  - 第三方回调标记已支付（`_mark_order_paid_in_tx` 内）

价格接口扩展：

- `GET /api/payment/pricing` 返回新增字段：
  - `services.light_consult_review.price`

### 2.5 结算/收入记录

修改文件：

- `backend/app/services/settlement_service.py`

新增方法：

- `SettlementService.ensure_income_record_for_paid_review_order(db, lawyer_id, order)`
  - 仅处理：`order_type == light_consult_review` 且 `status == paid`
  - 幂等：按 `(lawyer_id, order_no)` 查重
  - 生成 `LawyerIncomeRecord`（`consultation_id=None`，`order_no=...`）
  - 更新 `LawyerWallet.total_income/pending_amount`，冻结期使用现有 `SETTLEMENT_FREEZE_DAYS`

## 3. 仍未完成的关键点（下一位同事优先做）

### 3.1 P2.1 已完成项（供快速定位）

- **回归测试已补齐**：`backend/tests/test_api.py`

  - 新增用例覆盖：下单（light_consult_review）→ 余额支付 → 自动生成复核任务 → 律师 claim/submit → 生成收入记录 → 用户查询结果

- **用户侧前端已接入**：`frontend/src/pages/ChatHistoryPage.tsx`

  - 在“咨询摘要”弹窗中展示“律师复核”区块：状态（pending/claimed/submitted）+ 购买入口 + 复核结果 Markdown 展示
  - 购买流程使用 `SideBySideModal`（左确认/右支付方式）+ `PaymentMethodPicker`，并提供“支付提示”弹窗

- **律师侧前端已接入**：`frontend/src/pages/LawyerDashboardPage.tsx`
  - 新增 Tab：复核任务
  - 支持：任务列表（筛选 pending/claimed/submitted）→ 领取 → 编辑并提交（Markdown）

### 3.3 任务分配策略（可选增强）

当前后端是“律师自行领取”，并未做平台分配。

如要做“指派给特定律师”：

- 后端可增加 `admin assign` 接口或在创建任务时写入 `lawyer_id`
- 列表接口目前允许律师看到未分配任务；如果改成“仅看分配给自己的任务”，需调整 `lawyer_list_review_tasks` 查询条件

## 4. 本地验证与命令

后端测试：

- 在 `backend/` 目录：
  - `py -m pytest -q`

迁移：

- 在 `backend/` 目录：
  - `py scripts/alembic_cmd.py upgrade head`

生产/门禁要点（非常重要）：

- 当 `DEBUG=false`：
  - **Redis 为强依赖**：`REDIS_URL` 必须配置且 Redis 必须可用，否则后端启动失败（用于限流/分布式锁/周期任务）。
  - **数据库默认 Alembic head 门禁**：启动会校验 DB schema 是否已升级到 `head`，否则启动失败并提示迁移命令。
  - 临时应急（不建议长期使用）：可设置 `DB_ALLOW_RUNTIME_DDL=1` 放行 `init_db()` 的运行时 DDL 兜底路径。

## 5. 本次会话改动文件清单（快速定位）

新增：

- `backend/app/models/consultation_review.py`
- `backend/app/schemas/consultation_review.py`
- `backend/app/routers/reviews.py`
- `backend/alembic/versions/d4f2c9a31b10_add_consultation_review_tables.py`

修改：

- `backend/app/routers/payment.py`
- `backend/app/services/settlement_service.py`
- `backend/app/routers/__init__.py`
- `backend/app/database.py`
- `backend/app/models/__init__.py`
- `backend/app/models/payment.py`

说明：

## 6. TASKS.md 勾选建议

- `P2.1` 后端骨架已完成：
  - 订单类型 `light_consult_review` ✅
  - payment → review task 自动生成 ✅
  - 律师 claim/submit + 版本记录 ✅
  - settlement 生成收入记录 ✅
- `P2.1` 前端闭环与回归测试已完成：
  - `frontend/src/pages/ChatHistoryPage.tsx`：用户购买入口 + 状态/结果展示
  - `frontend/src/pages/LawyerDashboardPage.tsx`：律师任务列表/领取/提交
  - `backend/tests/test_api.py`：端到端回归覆盖

可在 `TASKS.md` 第十六阶段 P2.1 处勾选“工作流/验收标准”。

## 7. SEO/可索引化（第十七阶段）现状

- 已提供：`/robots.txt`、`/sitemap.xml`
  - 后端：`backend/app/main.py`
  - 前端生产代理：`frontend/nginx.conf`（精确匹配两个路径，避免 SPA fallback）
  - 前端开发代理：`frontend/vite.config.ts`
- canonical/OG：
  - 全站兜底：`frontend/src/components/Layout.tsx` 在路由切换时 upsert canonical、`og:url/og:type/og:site_name`
  - 首页兜底 meta：`frontend/index.html`

## 8. 论坛结构化发帖模板（第十七阶段）现状

- 不改后端表结构，仍复用 `PostCreate.content` / `PostUpdate.content`
- 前端提供“结构化模板”输入并合并到正文（Markdown）：
  - 新建帖子：`frontend/src/pages/NewPostPage.tsx`
  - 编辑帖子：`frontend/src/pages/EditPostPage.tsx`
- 行为：
  - 勾选“开启结构化模板”后可填写：案情经过/争议焦点/证据线索/诉求/进展
  - 点击“同步到正文”会把内容写入/覆盖正文中的对应 `##` 小节；正文为空则直接生成模板
  - 发布/保存会自动按同样规则合入最终 `content` 再提交后端

## 9. AI 回答反馈（第十八阶段）现状

- 存储：复用 `chat_messages.rating`（1/2/3）与 `chat_messages.feedback`（文本）
- A/B 与 Prompt 版本化（已落地，**不改表结构**）：
  - `chat_messages.references` 支持两种格式：
    - 旧：`[...]`（法条引用数组）
    - 新：`{"references": [...], "meta": {...}}`
      - `meta.prompt_version`：本次回答使用的 prompt 版本（用于灰度/对比）
  - 灰度配置：通过 `SystemConfig` 控制
    - `AI_PROMPT_VERSION_DEFAULT`
    - `AI_PROMPT_VERSION_V2`
    - `AI_PROMPT_VERSION_V2_PERCENT`
  - 灰度策略：稳定分桶（按 user_id / guest 标识 hash），保证同一用户/游客长期命中同一版本
- 用户侧入口：`frontend/src/pages/ChatPage.tsx`
  - AI 回复操作条（MessageActionsBar）点击好评/差评会弹出评价弹窗
  - 支持原因标签（Chip）+ 可选补充说明（写入 `feedback`）
  - 提交接口：`POST /api/ai/messages/rate`
  - 历史加载：`GET /api/ai/consultations/{session_id}` 返回 `rating/feedback` 以便刷新后保持已评价状态
- 管理端基础统计：
  - 接口：`GET /api/system/stats/ai-feedback`
  - 展示：`frontend/src/pages/admin/DashboardPage.tsx` 的 AI 反馈统计卡片（满意度/评价率/原因标签 Top/最近反馈）
  - 字段：`top_tags`（标签聚合，含好/中/差拆分）、`tag_messages_scanned`
  - 新增：`by_prompt_version`（按 prompt_version 聚合满意度/评价数）
