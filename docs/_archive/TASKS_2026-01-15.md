# TASKS 快照（2026-01-15）

来源：`TASKS_NEXT.md`（当前迭代）

## 本迭代目标：文档体系补齐（基于现有代码与配置）

- [x] 建立根 `README.md`（项目简介、启动方式、关键约定、文档入口）
- [x] 建立 `docs/` 文档体系（架构 / 数据库 / 开发指南 / API 速查 / 运维）
- [x] 修正 Helm README 中的文档/脚本引用，确保互链不悬空
- [x] 补齐 `backend/README.md`、`frontend/README.md`
- [x] 补齐发布需要的 `docs/CHANGELOG.md`（用于 GitHub Release workflow）

## 建议后续迭代（待评估）

- [x] 生产反向代理补齐 WebSocket `/ws` 路径（Nginx / Ingress）并补运维说明
- [x] 补齐 post-deploy smoke 脚本与 Runbook（对齐 `.github/workflows/post-deploy-smoke.yml`）

## 当前工作：开发者视角文档深度化（进行中）

- [x] 补齐模块级文档（`docs/modules/*`）并在主文档互链（ARCHITECTURE/README）
- [x] 修正文档一致性（章节编号/模块顺序/互链）并做一次全局校验
- [ ] 逐模块补齐数据流与关键表（forum/news/payment/settlement/notifications/reviews/consultation）
- [x] 补齐前端开发者文档（路由、React Query、WebSocket、鉴权与错误处理约定）
- [x] 补齐“开发者排障手册”与“配置参考”（env + SystemConfig + 生产约束）
- [x] 文档互链与目录检查（避免悬空链接）
- [x] 为核心链路补齐“端到端数据流”说明（请求->DB->通知/WS->前端缓存刷新）与关键表映射
- [x] 端到端数据流补强：补齐支付 pay_order 与复核提交->结算入账的耦合链路（DATA_FLOWS）
- [ ] 继续扩写各业务模块的“关键表字段/状态机”与“边界条件”（尤其是 payment/settlement/reviews）
- [x] 深挖支付/结算/复核文档：补齐 pay_order 边界条件、余额扣款原子性、回调审计策略、对账诊断与提现分摊规则
- [x] 补齐补充模块文档（documents/document-templates/contracts/knowledge/calendar/feedback/admin-console）并接入导航

## 自动执行计划（后续按顺序依次执行，不再逐步询问确认）

说明：以下为“可交付的文档增强”计划，每一项都包含：

- 交付物（会改哪些文档）
- 验收标准（完成到什么程度算过）
- 校验方式（互链校验/一致性检查）

### A. 数据模型补齐（以 `backend/app/models/*` 为准）

- [ ] A1 扩写 `docs/DATA_MODEL.md`：支付域（Payment）

  - 交付物：补齐 `payment_orders/user_balances/balance_transactions/payment_callback_events` 的关键字段、唯一约束、金额正负语义、与订单/回调/余额的关系
  - 验收：开发者能仅凭 DATA_MODEL + PAYMENT 模块文档定位“订单/回调/余额流水”三者的落库点与主键/唯一键

- [ ] A2 扩写 `docs/DATA_MODEL.md`：结算域（Settlement）

  - 交付物：补齐 `lawyer_wallets/lawyer_income_records/lawyer_bank_accounts/withdrawal_requests` 的关键字段、状态机、与 service 的一致性约束
  - 验收：开发者能从表字段推导出“pending/settled/withdrawn”与“pending/approved/rejected/completed/failed”的业务含义

- [ ] A3 扩写 `docs/DATA_MODEL.md`：复核域（Reviews）

  - 交付物：补齐 `consultation_review_tasks/consultation_review_versions` 的关键字段、唯一约束、与 payment order 的绑定关系
  - 验收：开发者能定位“谁创建 task、谁提交 version、如何去重、如何和结算入账联动”

- [ ] A4 扩写 `docs/DATA_MODEL.md`：通知域（Notifications）
  - 交付物：补齐 `notifications` 的字段语义、dedupe_key 语义、WebSocket 推送触发点
  - 验收：开发者能定位“为什么通知没插入/为什么重复/为什么 WS 没推送”

### B. 端到端数据流补齐（请求 →DB→ 通知/WS→ 前端刷新）

- [ ] B1 扩写 `docs/modules/DATA_FLOWS.md`：论坛审核/通知链路（forum -> notifications）

  - 交付物：补齐“发帖/评论->审核->通知->WS->前端刷新”的关键表与状态
  - 验收：能明确指出哪些 API 写哪些表，哪些动作会触发通知/WS

- [ ] B2 扩写 `docs/modules/DATA_FLOWS.md`：News / News AI 链路

  - 交付物：补齐“采集/发布/下架/News AI pipeline”主要任务与关键表落点（以代码为准）
  - 验收：能定位 pipeline 的 job、锁 key、写库点、常见失败点

- [ ] B3 扩写 `docs/modules/DATA_FLOWS.md`：通知模块链路（broadcast/system/WS）
  - 交付物：补齐“插入通知->去重->WS 推送->前端 invalidate”的全链路
  - 验收：能明确 dedupe_key 设计与前端缓存刷新点

### C. 排障手册补齐（面向线上/联调常见故障）

- [ ] C1 扩写 `docs/guides/TROUBLESHOOTING.md`：支付常见问题

  - 交付物：补齐“回调验签失败/回调重复/订单已 paid 但无成功回调/余额扣款失败/对账诊断”等
  - 验收：按文档步骤可复现定位到 `payment_callback_events` 或 reconcile diagnosis

- [ ] C2 扩写 `docs/guides/TROUBLESHOOTING.md`：结算/提现常见问题
  - 交付物：补齐“结算 job 未跑/冻结期不结算/提现金额与 wallet 对不上/提现完成但 income_records 未分摊”等
  - 验收：按文档步骤可定位到 `withdrawal_requests`/`lawyer_wallets`/`lawyer_income_records`

### D. 文档一致性与自动校验

- [ ] D1 对齐模块文档一致性（索引/章节/路由前缀/命名）

  - 交付物：确保 `ARCHITECTURE.md`、`modules/INDEX.md`、`API_QUICK_REFERENCE.md`、各模块文档互相一致
  - 验收：不存在“同一概念多种命名/同一接口多处不一致”

- [ ] D2 全库互链校验（自动脚本）
  - 校验方式：执行仓库内的 Markdown link target 校验（py 脚本）

### E. 任务归档

- [ ] E1 归档快照
  - 交付物：将当前迭代 `TASKS_NEXT.md` 快照归档到 `docs/_archive/TASKS_YYYY-MM-DD.md`
  - 验收：`TASKS.md` 仍为入口索引，历史可追溯
