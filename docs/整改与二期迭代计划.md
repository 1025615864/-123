# 甲方反馈整改与二期迭代计划（内部执行版）

> 适用范围：本计划将甲方反馈中“未完成/缺陷/需补齐”的事项转化为可执行迭代；用于内部研发排期、对齐范围与验收口径。

---

## 1. 背景与目标

甲方反馈集中在三类问题：

1. **律师服务业务闭环缺失**：缺少律师端/预约/订单/服务交付/评价/结算等闭环能力。
2. **支付与商业化不落地**：支付通道未实对接，缺少统一订单状态机、回调幂等、退款/结算/对账、会员/配额等商业化能力。
3. **合规与基础能力缺口**：用户协议/隐私政策/AI 免责声明、客服反馈、订单中心、（可选）实名等。

本计划的核心目标：

- 在可控范围内优先实现**“最小可运营闭环”**（订单 + 支付 + 律师服务 MVP）。
- 在交付物中补齐**合规必备项**，降低合规与投诉风险。
- 明确**依赖项与甲方需提供资料**，避免开发反复。

---

## 1.1 当前进度快照（截至 2026-01-04）

已落地（可演示/可回归）：

- P0 合规补齐：用户协议/隐私政策/AI 免责声明页面 + 注册勾选校验 + 同意记录落库（已完成）。
- P1 律师服务闭环 MVP（阶段性可用）：
  - 用户侧：律师认证申请入口页（可提交/可查状态）。
  - 管理端：律师认证审核页（通过/驳回），审核通过会将用户角色升级为 `lawyer`，并创建/更新 `Lawyer` 档案绑定到用户。
  - 律师端：律师工作台页（查看我的咨询预约，支持接单/拒单/标记完成）。
  - 支付状态机：律师咨询订单支付成功后会将咨询状态从 `pending` 更新为 `confirmed`。
  - 律师接单接口：当咨询已为 `confirmed` 时，“接单”接口幂等返回（不报错）。
- 自动化回归：

  - 后端 pytest：83 passed
  - 前端 build：通过
  - Playwright E2E：已覆盖新闻/论坛/支付/律所/移动端回归等关键路径；并包含 `frontend/tests/e2e/lawyer-service-closed-loop.spec.ts` 覆盖“认证审核 + 余额支付 + 律师接单确认”（最新回归：73 passed, 0 failed）。

标准信息完成情况（截至 2026-01-04）：

- 文档：
  - 已更新：`docs/CLIENT_PROJECT_REPORT.md`、`docs/PROJECT_REPORT.md`、`docs/TECHNICAL_INTEGRATION_REPORT.md`、`frontend/README.md`、`backend/README.md`
- 质量门禁与回归：

  - 后端：pytest 83 passed（CI 门禁项之一）
  - 前端：`npm run build` 通过（CI 门禁项之一）
  - E2E：Playwright `73 passed, 0 failed`

- M2 三方支付实对接（工程能力已补齐，待甲方联调资料）：
  - 支付回调事件落库：`PaymentCallbackEvent`（含幂等写入与失败留痕）。
  - 支付宝回调：RSA2 验签 + 幂等更新订单。
  - 微信支付回调（V3）：平台证书验签 + 回调资源解密（APIv3 key）+ 幂等更新订单 + 平台证书刷新机制。
  - 管理端：新增“支付回调审计”页面 `/admin/payment-callbacks`（列表/统计/微信证书刷新/订单对账）。

---

## 2. 范围与边界（重要）

### 2.1 本计划覆盖

- P0：合规补齐（前端页面 + 注册勾选 + 同意记录落库）
- P1：律师服务闭环 MVP（入驻申请/审核、律师资料、预约、接单/拒单、订单状态机、评价、非实时沟通）
- P1：支付实对接（至少一个渠道跑通：下单 → 支付 → 回调 → 状态落库）
- P1：商业化底座（权益/配额/会员模型，与订单/支付联动）
- P1：RAG 落地配套（数据规范 + 导入工具/流程 + 责任边界）
- P1：用户侧补齐（客服反馈、我的订单、站内消息线程）

### 2.2 本计划不覆盖（需另行立项/确认）

- 实时 IM/私信（可作为 P2/P3）
- 律师结算/提现/分账（依赖支付体系与业务规则，可作为 P2）
- 发票能力（依赖财务流程，可作为 P2）
- 实名认证接入（依赖第三方服务商与合规要求，可作为 P2）

---

## 3. 里程碑与交付物

> 工期/人力以评审为准，建议以“会议确认需求 → 固化验收 → 分期交付”推进。

### M0（P0）：合规补齐（高优先级，先做）

**目标**：补齐必备合规页面，并在注册/关键使用环节留存“同意记录”。

**范围**：

- 前端新增页面：
  - 用户协议
  - 隐私政策
  - AI 咨询免责声明
- 注册页：必须勾选“已阅读并同意上述文件”，否则不可注册。
- 后端：注册接口校验同意字段，并落库同意记录（版本号、时间戳、IP、UA）。

**交付物**：

- 前端合规页面与注册勾选校验
- 后端同意记录落库（含审计字段）
- 验收说明：页面入口与数据库查询方式

**回归门禁**：

- 前端：`npm run build` 通过
- 后端：pytest 通过（至少覆盖注册/同意记录相关用例）

**验收标准**：

- 未勾选无法提交注册；勾选后注册成功。
- 数据库可查询到新用户的同意记录（至少包含：文档类型、版本、时间、IP/UA）。
- 页脚/注册页可跳转到合规页面。

**当前状态**：已完成。

**风险/依赖**：

- 合规文案最终版本由甲方/法务确认（当前先用占位文本，后续替换）。

---

### M1（P1）：律师服务闭环 MVP（最小可运营闭环）

**目标**：形成可运营主链路：浏览律师 → 预约 → 下单/支付 → 服务交付 → 完成确认 → 评价。

**范围（建议拆为 1.0/1.1）**：

- 律师入驻申请（用户提交资料）
- 管理端审核（通过/驳回/补充材料）
- 律师资料维护（擅长领域、服务项目、价格）
- 用户预约（选择律师 + 服务类型/价格 + 问题描述 + 期望时间）
- 律师接单/拒单（含超时规则）
- 订单状态机：待支付/已支付/服务中/已完成/已评价/已取消
- 沟通方式：订单留言/站内消息线程（不做实时 IM）
- 用户评价（评分 + 文本）

**交付物**：

- 业务链路与页面：
  - 用户侧：入驻申请入口、预约下单、订单中心（查看/支付/取消/详情）
  - 律师侧：工作台（待处理预约、接单/拒单/完成）
  - 管理端：入驻审核与基础运营管理
- 后端状态机：咨询/订单状态与支付状态联动（含幂等校验）
- 自动化回归：Playwright 覆盖闭环链路（含认证审核 + 支付 + 律师接单确认）

**回归门禁**：

- 前端：`npm run build` 通过
- 后端：pytest 通过
- E2E：Playwright 关键链路用例通过（包括 `lawyer-service-closed-loop.spec.ts`）

**验收标准**：

- 以普通用户完成一次“预约 → 支付 → 服务完成 → 评价”全流程。
- 管理员可看到入驻申请/审核记录。
- 律师可看到待处理预约并做接单/拒单。

**当前状态**：已完成 1.0（可运营主链路已跑通，含自动化回归）。

- 已具备：认证申请/审核、律师工作台、咨询预约、余额支付、支付后状态机一致（支付后 `pending` → `confirmed`，并可由律师接单进入下一阶段流程）。
- 已补齐入口与页面：
  - 用户侧：统一订单中心 `/orders`（支付订单 + 律师预约整合，支持 tab 切换）
  - 用户侧：`/lawyer/verification`
  - 律师侧：`/lawyer`
  - 管理端：`/admin/lawyer-verifications`
- 已补齐回归用例：Playwright `lawyer-service-closed-loop.spec.ts`

**已完成（1.1 里程碑内）**：

- 订单留言/站内消息线程（非实时）落地（与律师订单绑定）。
- 用户评价（评分+文本）：完成后可评价；律师详情页展示评价列表与均分。
- 预约取消与余额退款（最小闭环）：用户取消已支付且支付方式为余额的咨询，将自动退款并保证幂等。

**待推进（建议作为 1.1）**：

- 接单 SLA / 超时规则（需甲方确认 SLA 与规则）。
- 三方支付订单的退款规则与接口联动（需甲方支付渠道联调资料）。

建议拆分为以下可交付任务（M1.1）：

1. 订单留言 / 站内消息线程（非实时）

- 后端：
  - 数据模型：消息线程（按咨询预约/订单聚合）、消息记录（发送者/内容/时间/已读）。
  - 权限：仅咨询双方（用户/律师）可读写；管理员可只读审计（可选）。
  - API：
    - 创建/获取线程
    - 拉取消息列表（分页）
    - 发送消息
    - 标记已读
- 前端：
  - 用户侧：在“我的预约/订单详情”内展示消息线程
  - 律师侧：在律师工作台内进入某条咨询的消息线程
- 通知（可选）：新消息产生站内通知（非实时推送，仅轮询/进入页面刷新亦可）

**验收标准**：

- 用户发起一条留言，律师端可看到并回复。
- 非咨询参与方无法读取/发送该线程消息（返回 403）。

2. 用户评价（评分 + 文本）

- 后端：
  - 评价模型与 API：创建评价、查询评价列表（按律师）、（可选）删除/屏蔽
  - 约束：仅已完成/已确认完成的咨询可评价（规则需甲方确认）
- 前端：
  - 用户侧：在咨询完成后可提交评价
  - 律师/用户侧：律师详情页展示评价列表与均分

**验收标准**：

- 用户完成一次“确认完成 → 提交评价”，律师详情页可看到该评价。

3. 用户侧“我的订单/我的预约”整合

- 前端：
  - 统一入口：个人中心/订单页
  - 展示字段：订单号、金额、支付状态、咨询状态、创建时间、操作（去支付/取消/查看详情）
- 后端（如需）：
  - 聚合接口或前端聚合策略确定（以成本最低为准）

**验收标准**：

- 用户可在一个页面内清晰看到“待支付/已支付/待律师确认/已确认/已完成”的订单与预约。

**当前状态**：已完成。

- 前端已落地统一订单中心：`/orders`（tab 支持 `payment/consultations`），并已将相关入口跳转统一到该页面。

4. 取消/超时/退款规则（先规则落地，再做接口）

- 规则（需甲方确认）：
  - 接单 SLA：多久未接单允许用户取消/自动取消
  - 退款策略：是否全额/部分、是否需要管理员介入
  - 完成确认：由谁确认完成、何时可评价
- 技术落地：
  - 新增取消接口（用户侧）
  - 新增退款接口（管理员侧或自动退款）
  - 状态机校验（避免非法状态跳转）

**验收标准**：

- 用户可取消“未接单”的预约并按规则退款（至少支持余额退款演示）。

**风险/依赖**：

- 甲方需确认：服务形态（文字/电话/视频）、收费方式、退款规则、接单 SLA。

---

### M2（P1）：支付实对接（至少一个渠道跑通）

**目标**：实现支付可用的最小闭环，回调能驱动业务状态变更。

**范围**：

- 统一订单模型与状态机（与律师预约订单对齐）
- 回调幂等、验签、落库
- 至少一个支付渠道跑通：微信或支付宝

**交付物**：

- 支付回调事件审计：`PaymentCallbackEvent`（含失败留痕）
- 支付渠道回调验签 + 幂等：支付宝（RSA2）/ 微信（V3 验签 + 解密）
- 管理端审计能力：回调事件查询/统计、对账辅助、证书刷新（如微信）

**回归门禁**：

- 后端：pytest 通过（至少覆盖回调验签失败/重复回调幂等/订单状态机校验）
- E2E/冒烟：具备联调资料后，至少完成 1 次“下单 → 支付 → 回调 → 业务状态变更”演示

**验收标准**：

- 生成订单 → 发起支付 → 收到回调 → 订单状态变为“已支付”。
- 重复回调不会导致重复记账/重复状态变更。

**当前状态**：

- 已落地：

  - 统一订单模型与状态机（含余额支付）。
  - 回调事件落库：`PaymentCallbackEvent`（验签成功/失败均留痕）。
  - 回调幂等：重复回调不会导致重复状态变更/重复记账。
  - 支付宝回调：RSA2 验签（`/api/payment/alipay/notify`）。
  - 微信支付回调：V3 平台证书验签 + 回调资源解密（`/api/payment/wechat/notify`），并提供平台证书刷新接口（管理员）。
  - 管理端审计：
    - API：回调事件列表/统计、订单对账。
    - UI：`/admin/payment-callbacks`。

- 待甲方联调资料：
  - 支付宝：`app_id`、公钥/私钥、回调白名单、沙箱账号。
  - 微信：`mch_id`、商户私钥、商户证书序列号、APIv3 key、回调白名单、沙箱/生产联调环境。
  - 具备以上资料后，可完成沙箱/生产真实回调联调与验收。

建议拆分为以下可交付任务（M2）：

1. 渠道选型与联调环境准备

- 明确本期只跑通一个渠道：支付宝或微信（建议优先甲方已有资质/沙箱更完善的渠道）。
- 甲方提供：
  - 商户参数（app_id/mch_id 等）
  - 私钥/证书、公钥、回调 URL 白名单
  - 沙箱账号与联调文档

**验收标准**：

- 可在沙箱环境生成订单并发起支付，回调可打通。

2. Webhook 回调：验签 + 幂等 + 落库

- 验签通过才允许更新订单状态。
- 幂等：重复回调不会重复记账/重复发放权益。
- 失败处理：验签失败/金额不一致/订单不存在等均有可观测日志。

**验收标准**：

- 通过模拟/沙箱回调重复触发 2 次，订单/余额/交易记录只更新一次。

3. 退款与对账（可选拆为 M2.1）

- 退款：
  - 余额支付：可直接退款回余额
  - 三方支付：走渠道退款接口（需甲方提供权限/配置）
- 对账：提供基础对账导出/查询（管理员可查订单与交易记录）

**验收标准**：

- 对已支付订单可触发退款并正确落库（至少余额退款演示可用）。

**风险/依赖**：

- 甲方需提供商户参数、证书/密钥、回调白名单与联调环境。

---

### M3（P1）：商业化底座（配额/权益/会员）

**目标**：明确并落地收费策略、权益与配额扣减。

**范围**：

- 权益模型（会员/次数包/有效期）
- AI 咨询配额（游客/登录用户）与超额策略
- 文书生成次数/付费策略（如需）

**交付物**：

- 权益/配额数据模型与扣减规则
- 管理端配置入口（价格表/权益包/有效期等，以最小可用为准）
- 用户侧展示：当前权益与剩余额度（如需）

**回归门禁**：

- 后端：pytest 通过（至少覆盖扣减幂等/超额策略/有效期）
- 前端：`npm run build` 通过

**验收标准**：

- 后端可查询用户权益/剩余额度；超额行为符合策略。

**风险/依赖**：

- 甲方需确认价格表与权益策略。

---

### M4（P1）：知识库/RAG 落地配套

**目标**：让“知识库/向量化”从工程能力变成可运营流程。

**范围**：

- 数据字段规范（CSV/JSON）
- 导入与向量化工具（命令/接口/后台入口其一）
- 更新机制与责任边界说明

**交付物**：

- 数据规范模板（样例 CSV/JSON）与字段校验规则
- 导入/向量化流程（命令/接口/后台入口之一）与可观测日志
- 运维说明：如何增量更新、失败重试、回滚与责任边界

**回归门禁**：

- 在样例数据集上完成：导入 → 向量化 → 检索验证（可重复执行，结果可解释）

**验收标准**：

- 在提供样例数据后，可完成导入 → 向量化 → 检索验证。

---

### M5（P1）：用户侧补齐

**范围**：

- 客服/反馈工单（最简闭环）
- 我的订单（承接律师服务/支付）
- 站内消息线程（非实时）

**交付物**：

- 客服/反馈：用户提交 → 管理端处理 → 状态闭环（最简）
- 订单中心：统一入口展示支付订单/律师预约订单（tab 或聚合）
- 站内消息：与订单/咨询绑定的非实时消息线程

**验收标准**：

- 用户可提交反馈并查看处理状态；管理员可处理并留痕。
- 用户可在“我的订单/预约”中完成：查看详情/去支付/取消等关键操作。
- 用户发起留言，律师端可看到并回复；无权限用户访问返回 403。

**回归门禁**：

- 前端：`npm run build` 通过
- 后端：pytest 通过
- E2E：核心用户链路冒烟（登录 → 订单中心 → 详情 → 留言）通过

---

## 4. 依赖与甲方需提供项（联调前置清单）

- **支付**：商户参数、证书/密钥、回调地址白名单、沙箱/生产环境要求、是否分账。
- **律师服务业务规则**：服务形态、定价方式、退款规则、接单 SLA、完成确认规则、资质审核材料清单。
- **商业化**：会员/配额/定价策略。
- **合规文本**：用户协议、隐私政策、AI 免责声明最终版本。
- **RAG 数据**：数据来源与授权、初始数据提供方式、更新频率。

---

## 5. 技术实施顺序（建议）

1. P0 合规补齐（低耦合、可快速验收）
2. 订单模型统一（为律师服务与支付打底）
3. 律师服务闭环 MVP（不含实时 IM）
4. 支付实对接（至少一个渠道跑通）
5. 商业化权益/配额与计费
6. RAG 数据导入与更新机制
7. 后台财务/结算/营销等增强

---

## 6. 风险清单

- 合同范围界定不清导致“做了也无法验收/持续加需求”。
- 支付对接参数/证书不齐导致联调延期。
- 律师服务业务规则不确定导致返工。
- RAG 数据来源/授权不明确导致无法上线。

---

## 7. 验收与回归执行清单（建议）

> 目的：给测试/甲方验收一个“可复制”的最小流程，确保每次交付都有可追溯回归记录。

### 7.1 回归口径（建议统一记录）

- 回归日期：YYYY-MM-DD
- 回归环境：本地/测试/预发（含域名/端口）
- 代码版本：git commit hash（或 tag）
- 数据准备：是否使用 DEBUG 接口/固定测试账号
- 结果：pytest/build/E2E 的通过数与失败用例（必要时附失败截图/trace）

### 7.2 后端回归（pytest）

- 在 `backend/` 目录执行：
  - `py -m pytest`

### 7.3 前端构建回归（build）

- 在 `frontend/` 目录执行：
  - `npm run build`

### 7.4 前端端到端回归（Playwright E2E）

- 在 `frontend/` 目录执行：
  - `npm run test:e2e`

说明（常见不稳定来源与处理约定）：

- 前端 `AuthContext` 会校验 `localStorage.token` 必须为可解码且未过期的 JWT；纯前端 mock 场景请使用 `frontend/tests/e2e/helpers.ts` 的 `makeE2eJwt()`。
- 热门新闻榜单为排序 + limit 场景，E2E 通过 DEBUG 管理接口一次性准备数据：`POST /api/news/admin/{news_id}/debug/set-view-count`（仅 `debug=true` 可用）。
- `/admin/settings` 默认 tab 为 `base`，部分运维卡片只在 `AI 咨询` / `新闻 AI` tab 渲染，E2E 断言前需先切 tab。
- 移动端底部导航与“更多”弹层入口随导航结构调整：论坛入口在底部导航，工具类（如日历）在“更多”弹层。
