# 开发方案与里程碑计划（律师结算 + 商业化落地）（v1.1）

项目名称：百姓法律助手（百姓助手）

版本：v1.1

更新时间：2026-01-05

适用对象：甲方业务/产品/验收，甲方研发/运维/测试，乙方研发/交付

---

## 1. 背景与目标

本方案基于以下材料制定：

- `docs/律师结算功能需求说明书.md`（结算/提现 MVP）
- `docs/百姓法律助手商业化策略与定价方案.md`（定价/会员/分成策略）
- `docs/百姓法律助手验收测试用例.md`（验收用例清单）
- `docs/补充协议模板.md`（范围确认与里程碑对齐）

当前交付版（v1.0）已具备：律师服务 MVP 闭环（预约-支付-确认-接单-完成-评价）、余额支付闭环、支付宝支付链接生成（需甲方参数）、支付回调审计/对账工具、合规页面与同意留痕、以及自动化回归门禁（pytest 95 passed / Playwright 73 passed / pyright+bpyright 0）。

本方案的目标是把 v1.0 的“可验收 MVP”进一步升级为“可运营闭环”，重点补齐：

- 律师结算/提现（收入记录、冻结期、提现申请/审核/打款标记）
- 商业化策略可落地（会员权益与配额/次数包的执行与扣减）
- 验收用例与交付里程碑对齐（让甲方可直接照用例验收、照协议签收）

---

## 2. 当前现状与差距（对照 v1.0）

### 2.1 已完成（可验收/可回归）

- 前端统一订单中心：`/orders`（tab：支付订单 / 律师预约）
- 律师认证：`/lawyer/verification`；管理端审核：`/admin/lawyer-verifications`
- 律师工作台：`/lawyer`（接单/拒单/标记完成）
- 评价：已完成咨询可评价、律师详情可查看评价
- 支付订单：创建/列表/详情/取消；余额支付闭环；支付宝支付链接生成
- 支付回调验签与审计：回调事件留痕、订单对账诊断、微信平台证书刷新/导入
- 合规：`/terms` `/privacy` `/ai-disclaimer` + 注册勾选 + 同意留痕

### 2.2 v1.1 已完成（可验收/可回归）

- 律师结算/提现（对应本方案 M1）：

  - 钱包/收入记录/冻结期到期结算任务（后台定时任务 + 管理员手动触发）
  - 提现申请/审核/打款完成/失败标记
  - 律师收款账户管理（银行卡 MVP；字段加密存储 + 脱敏展示）
  - 导出：律师收入记录 CSV、管理员收入记录 CSV、管理员提现申请 CSV

- 商业化权益与配额（对应本方案 M2）：

  - AI 咨询、文书生成按“每日配额 + 次数包余额 + VIP”进行限制与扣减
  - 价格表：VIP 天数/价格、AI 咨询次数包、文书生成次数包（支持 SystemConfig 动态覆盖，缺省回落到环境变量/默认值）

- 验收用例与补充协议对齐（对应本方案 M3）：

  - 已将新增结算/商业化用例补入 `docs/百姓法律助手验收测试用例.md`
  - 已更新 `docs/补充协议模板.md` 与交付口径对齐，并补充验收/交付模板

---

## 3. 里程碑与交付现状（截至 2026-01-05）

> 下述里程碑为 v1.1 的交付拆分；当前仓库代码与文档已按 M1/M2/M3 落地，可直接按验收用例执行验收。

### M0：需求确认与验收口径固化（已完成）

**目标**：把不确定的业务规则固化为“可实现/可验收”的参数。

**甲方需确认（输出确认单）**：

- 律师结算：

  - 平台抽成比例（建议 15%）
  - 冻结期（建议 7 天）
  - 最低提现金额（建议 100 元）
  - 手续费（建议 0 元）
  - 到账 SLA（建议 3 个工作日）
  - 提现方式：银行卡（MVP），支付宝（可选）

- 商业化：
  - AI 咨询免费额度（游客/注册/VIP）
  - 会员权益（是否不限次、字数限制、历史记录保留等）
  - 次数包（10/50/100 次）是否纳入 v1.1
  - 文书是否收费/按次扣减

**乙方输出**：

- 数据模型草案（ER 说明）
- API 清单（含权限）
- 验收用例映射表（对应 `docs/百姓法律助手验收测试用例.md`）

---

### M1：律师结算/提现 MVP（已交付）

**目标**：在不对接企业付款接口的前提下，实现“收入记录 → 冻结期 → 提现申请 → 审核 → 人工打款标记 → 台账可追溯”的闭环。

#### 3.1 数据模型（后端）

建议新增表（命名可调整）：

- `lawyer_wallets`

  - `lawyer_id`
  - `total_income` / `withdrawn_amount` / `pending_amount` / `frozen_amount` / `available_amount`

- `lawyer_income_records`

  - `consultation_id` / `order_no`
  - `user_paid_amount` / `platform_fee` / `lawyer_income`
  - `status`：`pending` / `settled` / `withdrawn`
  - `settle_time`

- `lawyer_bank_accounts`

  - `account_type`：`bank_card` / `alipay`
  - `account_no`（敏感字段：需加密/脱敏展示）
  - `is_default`

- `withdrawal_requests`
  - `request_no`
  - `amount` / `fee` / `actual_amount`
  - `withdraw_method` / `account_info`
  - `status`：`pending` / `approved` / `rejected` / `completed` / `failed`
  - `admin_id` / `reviewed_at` / `completed_at`

#### 3.2 触发与状态机

- 收入确认触发：

  - 当咨询从 `confirmed` 被律师标记为 `completed` 时，创建 `income_record(status=pending)`。
  - `settle_time = completed_at + FREEZE_DAYS`。

- 冻结期解除：

  - 每日定时任务扫描 `settle_time <= now` 且 `status=pending` 的记录，置为 `settled` 并更新钱包。

- 提现：
  - 律师提交提现申请：冻结对应金额（从 available → frozen）。
  - 管理员审核：
    - 通过：`approved`（待打款）
    - 驳回：返还冻结金额（frozen → available）
  - 管理员“打款完成”：`completed`，更新钱包 withdrawn。
  - 打款失败：`failed`，按规则返还或保留冻结（由甲方确认）。

#### 3.3 API（已落地，均带 `/api` 前缀）

- 律师端：

  - `GET /api/lawyer/wallet`
  - `GET /api/lawyer/income-records`
  - `GET /api/lawyer/income-records/export`
  - `GET /api/lawyer/withdrawals`
  - `GET /api/lawyer/withdrawals/{withdrawal_id}`
  - `POST /api/lawyer/withdrawals`
  - `GET /api/lawyer/bank-accounts` / `POST` / `PUT` / `DELETE` / `PUT /default`

- 管理端：

  - `GET /api/admin/withdrawals`
  - `GET /api/admin/withdrawals/export`
  - `GET /api/admin/withdrawals/{withdrawal_id}`
  - `POST /api/admin/withdrawals/{withdrawal_id}/approve`
  - `POST /api/admin/withdrawals/{withdrawal_id}/reject`
  - `POST /api/admin/withdrawals/{withdrawal_id}/complete`
  - `POST /api/admin/withdrawals/{withdrawal_id}/fail`
  - `GET /api/admin/settlement-stats`
  - `POST /api/admin/settlement/run`（手动执行到期结算）
  - `GET /api/admin/income-records/export`

#### 3.4 前端页面（已落地）

- 律师端：

  - `/lawyer/income` 收入概览
  - `/lawyer/withdraw` 提现申请
  - `/lawyer/withdrawals` 提现记录
  - `/lawyer/bank-accounts` 收款账户管理

- 管理端：

  - `/admin/withdrawals` 提现审核
  - `/admin/settlement-stats` 结算统计

#### 3.5 验收用例映射（对应 `百姓法律助手验收测试用例`）

建议新增/补充用例（编号可延续）：

- `TC-SETTLE-001` 咨询完成后自动生成收入记录（pending）
- `TC-SETTLE-002` 冻结期内不可提现
- `TC-SETTLE-003` 冻结期结束后可提现（settled）
- `TC-SETTLE-004` 律师提交提现申请（pending→approved/rejected）
- `TC-SETTLE-005` 管理员标记打款完成（completed）

---

### M2：商业化与定价落地（已交付）

**目标**：把 `商业化策略与定价方案` 中的核心策略变成“系统可执行规则”。

已按“先硬编码策略可验收 → 再做后台可配置”的方式落地：

#### 3.6 MVP 交付（可验收，已落地）

- AI 咨询：

  - 游客：按 IP 限制（`/api/ai/chat`、`/api/ai/chat/stream`）
  - 登录用户：按账号“每日配额”限制（`/api/user/me/quotas` 可查看）
  - VIP：更高上限（SystemConfig 可配置覆盖）

- 文书生成：

  - 登录用户按账号“每日配额 + 次数包余额”扣减（`/api/documents/generate`）
  - 游客可按 IP 限制（默认关闭，可通过环境变量开启）

- 会员：

  - 复用 `vip_expires_at` 字段与 VIP 购买订单逻辑
  - 在 AI/文书入口执行“配额校验 + 记录扣减”
  - 价格表接口：`GET /api/payment/pricing`

#### 3.7 数据模型（已落地）

- `user_quota_daily`：用户每日用量计数

  - 字段示例：`day`、`ai_chat_count`、`document_generate_count`

- `user_quota_pack_balances`：次数包余额（由支付成功后增加，在使用时扣减）
  - 字段示例：`ai_chat_credits`、`document_generate_credits`

#### 3.8 管理端配置（已落地）

- 系统配置：`GET /api/system/configs`、`PUT /api/system/configs/{key}`、`PUT /api/system/configs/batch`
- 可配置项（示例）：

  - `VIP_DEFAULT_DAYS` / `VIP_DEFAULT_PRICE`
  - `AI_CHAT_PACK_OPTIONS_JSON` / `DOCUMENT_GENERATE_PACK_OPTIONS_JSON`
  - `FREE_AI_CHAT_DAILY_LIMIT` / `VIP_AI_CHAT_DAILY_LIMIT`
  - `FREE_DOCUMENT_GENERATE_DAILY_LIMIT` / `VIP_DOCUMENT_GENERATE_DAILY_LIMIT`

---

### M3：验收用例对齐与补充协议落地（已交付）

**目标**：让甲方按 `验收测试用例` 可直接验收；按 `补充协议模板` 可直接签收。

- 将新增结算/商业化用例补入 `docs/百姓法律助手验收测试用例.md`
- 在 `docs/补充协议模板.md` 中，将里程碑 M1/M2 的交付内容与当前实现对齐
- 新增交付辅助文档：

  - `docs/验收与交付清单.md`
  - `docs/功能验收确认单（模板）.md`

---

## 4. 风险与依赖

- **支付对接依赖**：支付宝/微信真实支付能力依赖甲方商户参数与回调白名单。
- **合规与隐私**：银行卡号等敏感字段需加密存储与脱敏展示；日志需避免泄露。
- **冻结期与退款规则**：收入确认与可提现的时间点强依赖“服务完成/退款”规则。
- **运营策略不确定导致返工**：定价/权益/次数包需要甲方先确认。

---

## 5. 删除/归档建议（针对旧计划文档）

- 旧的“计划/规划/交接”类文档已统一放在 `docs/_archive/` 目录用于追溯。
- 若甲方/交付侧只以“交付现状文档 + 验收用例 + 补充协议”为准，可进一步删除 `docs/_archive/` 中的旧计划类文档以瘦身。
