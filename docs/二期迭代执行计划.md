# 二期迭代执行计划（基于代码现状对照）

更新时间：2026-01-08

最近更新摘要：

- 2026-01-08：E2E 稳定性修复已合并回 main（PR #18/#19）。
- 2026-01-08：main 上 Playwright E2E 全量回归（--workers=1）86 passed。
- 2026-01-08：本计划文档维护：PR #20 补充“最新回归记录”；PR #21 增加“最近更新摘要”。

当前执行状态（2026-01-08）：

- Milestone 0：已完成“计划文档维护”；docs 归档策略与目录清单待执行。
- Milestone 1（P0）：待执行（短信 + 邮箱验证与敏感操作二次校验）。
- Milestone 2（P0/P1）：以代码为准，多数能力已具备；生产支付联调与回归待执行。
- Milestone 3/4/5：待执行。

---

## 0. 目标与边界

本计划的目标是：在不破坏现有核心闭环（律师服务/支付/结算、新闻、论坛、AI 咨询与工具等）的前提下，优先解决阻塞上线的 P0 问题，并以可验证、可回归的方式推进商业化与用户体验提升。

本计划遵循：

- 以当前代码实现为准（非仅以文档设想为准）。
- 先 P0 安全与闭环可用性，再做 P1 商业化与体验，再做 P2 长期能力（运营/增长/推荐等）。
- 每个里程碑都必须具备：接口契约、数据库迁移（如需）、前端落地、自动化回归（pytest/e2e）与验收清单。

---

## 1. 当前项目现状（以代码为准）

### 1.1 已具备的基础能力（摘要）

- 账号体系：用户注册/登录、用户协议/隐私/AI 免责声明勾选留痕（UserConsent）。
- 律师服务闭环：律所/律师展示、预约咨询、支付订单、律师工作台处理（接单/拒单/完成）、结算与提现（已有结算模型与服务）。
- 支付与商业化：订单体系、VIP（vip_expires_at）、AI 次数包（ai_chat / document_generate credits）、余额体系（UserBalance/BalanceTransaction），并具备 /api/payment/pricing 与 /api/payment/balance。
- 文书生成：存在 /api/documents（模板式文本生成），并带游客额度限制。
- 新闻模块与管理后台：新闻/采集/News AI/配置等能力存在（具体以 admin 页面与后端路由为准）。
- 自动化：后端 pytest、前端 e2e 与类型检查已有基础覆盖。

### 1.2 已确认的关键缺口（对照专家文档）

P0（阻塞上线）：

- 手机号绑定/敏感操作缺少短信验证码“权限策略与敏感操作二次校验”（后端已具备 /sms/send、/sms/verify 与 phone_verified 字段；前端已落地绑定/验证 UI，但提现/绑卡等敏感操作仍需强制校验策略）。
- 注册邮箱缺少“注册后导流与未验证限制策略”（后端已具备 /email-verification/request、/email-verification/verify 与 email_verified 字段；前端已补齐 /verify-email、/forgot-password、/reset-password 与登录页“忘记密码”入口，但注册后提示/重发入口、敏感操作限制策略仍需补齐）。
- 余额体系后端已存在；前端已在个人中心落地余额展示/充值/明细，并补齐“余额不足 -> 去充值”导流与支付完成提示弹窗；仍需联调真实支付配置（支付宝）与自动化回归。
- 文书生成模块当前为纯文本模板，缺专业模板、预览编辑与 Word/PDF 导出。

P1（强烈建议尽快做）：

- 无独立 VIP 权益展示页（目前仅在个人中心里购买，转化弱）。
- 购买流程偏“confirm/简陋弹窗”，缺确认订单页、支付失败重试与余额不足引导。

P1/P2（业务闭环扩展）：

- 律所模块缺 firm_admin 等“律所管理闭环”（律所管理员、律师邀请/管理、财务/结算归集等）。

---

## 2. 里程碑规划

### Milestone 0：文档与项目治理（本周完成）

交付物：

- 本《二期迭代执行计划》
- docs 归档策略与文档目录清单（避免根目录文档堆叠）

验收：

- docs/ 根目录只保留“当前有效、持续维护”的交付/运维/验收类文档
- 阶段性分析类文档归档至 docs/\_archive，且可追溯

---

### Milestone 1（P0）：账号安全与验证体系（短信 + 邮箱）

目标：让账号具备上线基本安全能力，并为提现/绑卡/敏感操作提供二次验证基础。

#### M1.1 手机号短信验证码

后端：

- 已存在接口（需联调/补回归/补配置）：
  - POST /api/user/sms/send（scene + phone）
  - POST /api/user/sms/verify（scene + phone + code）
- 已存在数据字段：
  - users.phone_verified（bool）
  - users.phone_verified_at（datetime，可选）
- 需要确认/补齐：
  - Redis/Cache 可用性（验证码 TTL、发送锁/限流）
  - 短信服务商配置与模板/签名（生产必须）
  - phone 手动修改时需重置 phone_verified（避免不一致，已补）

前端：

- 个人中心新增“手机号绑定与验证”组件（已落地：发送验证码/校验绑定；DEBUG 下回显 code）
- 敏感操作（提现、绑卡）接入二次验证（至少在 UI 与后端校验上闭环）

测试：

- 新增 pytest：
  - 发送验证码限流
  - 验证码校验正确/错误/过期
  - 绑定手机号后 phone_verified 状态变化

#### M1.2 注册邮箱验证

后端：

- 已存在字段与接口（需联调/补回归/补前端导流）：
  - users.email_verified（bool）
  - users.email_verified_at（datetime，可选）
  - POST /api/user/email-verification/request
  - GET /api/user/email-verification/verify?token=...
  - POST /api/user/password-reset/request
  - POST /api/user/password-reset/confirm
- 需要确认/补齐：
  - 邮箱服务配置（SMTP/第三方服务）
  - token TTL 与频控策略（避免刷接口/撞库）

前端：

- 已补齐：
  - /verify-email（邮箱验证落地页）
  - /forgot-password、/reset-password（找回/重置密码落地页）
  - /login 增加“忘记密码？”入口
- 仍需补齐：
  - 注册成功后提示“验证邮件已发送”并提供“重发”入口
  - 未验证邮箱时的持续提醒/限制策略（至少覆盖提现/绑卡等敏感操作）

测试：

- 新增 pytest：
  - verify token 正确/错误/过期
  - 未验证邮箱的权限限制策略（如果启用）

---

### Milestone 2（P0/P1）：钱包体验（余额展示 + 充值入口）

目标：让用户清楚看到自己的余额与消费/充值记录，提升信任与转化。

后端：

- 确认并稳定以下接口契约：
  - GET /api/payment/balance
  - GET /api/payment/balance/transactions
  - POST /api/payment/orders（order_type=recharge）
  - POST /api/payment/orders/{order_no}/pay（alipay/wechat）

前端：

- 已落地（/profile）：
  - 我的资产卡片：余额、冻结、累计充值、累计消费
  - 余额明细弹窗：拉取 /payment/balance/transactions
  - 充值弹窗：创建 recharge 订单并打开支付宝 pay_url
  - 支付完成提示弹窗：引导“我已支付 -> 刷新余额/权益 / 去订单页查看”
  - 余额不足导流：余额支付失败时引导去充值（含 /orders 跳转 /profile?recharge=1）
  - 支持 /profile?recharge=1&amount=... 打开充值弹窗
- 已补齐（支付闭环）：
  - 支付完成后的状态刷新策略：
    - /orders 支持“刷新/刷新状态”按钮
    - 支付完成提示弹窗可触发刷新
    - 新增 /payment/return 支付回跳页（支持 out_trade_no=order_no），可自动轮询订单状态
  - 支付配置联调（支付宝）：
    - 后端已支持 /payment/alipay/notify（RSA2 验签 + 幂等落库 + 订单状态更新）
    - pay_url 生成时会附带 return_url：
      - 优先使用 ALIPAY_RETURN_URL
      - 未配置时默认回跳到 FRONTEND_BASE_URL/payment/return

配置项（生产必须显式检查）：

- ALIPAY_APP_ID
- ALIPAY_PRIVATE_KEY（RSA2 私钥，PEM）
- ALIPAY_PUBLIC_KEY（支付宝公钥，PEM，用于 notify 验签）
- ALIPAY_NOTIFY_URL（必须是公网可访问 URL，指向 /api/payment/alipay/notify）
- ALIPAY_RETURN_URL（可选；不配则用 FRONTEND_BASE_URL/payment/return）
- FRONTEND_BASE_URL（用于拼接默认 return_url）

生产联调建议步骤：

1. 配置环境变量后，登录管理后台 /admin/payment-callbacks 检查：
   - 支付宝：APP_ID / PRIVATE_KEY / PUBLIC_KEY / NOTIFY_URL 均为“已配置”
   - 校验 notify_url / effective_return_url（若未配 ALIPAY_RETURN_URL，会展示 fallback 到 FRONTEND_BASE_URL/payment/return）
2. 在支付宝开放平台/商户后台将异步通知地址配置为 notify_url（必须公网可访问）。
3. 发起一笔真实充值/购买：前端打开 pay_url 完成支付。
4. 支付完成后：
   - 用户侧：回跳 /payment/return 或在订单页刷新状态
   - 管理侧：/admin/payment-callbacks 查看“回调事件列表”是否出现 verified=true 且 error_message 为空
5. 若订单未更新：
   - 先看回调事件 error_message（验签失败/金额不一致/订单不存在等）
   - 再用“订单对账”输入 order_no 获取诊断信息

测试：

- e2e：
  - 订单页刷新能力（mock）
  - 支付回跳页 /payment/return（mock 订单详情，点击刷新后状态变为 paid）
- pytest：
  - 余额接口返回结构稳定

---

### Milestone 3（P0）：律师工作台与认证链路冒烟修复

目标：确保律师角色用户可以稳定进入 /lawyer，并可处理预约。

内容：

- 联调验证账号：lawyer1 / lawyer123
- 若出现 403：
  - 区分“无权限（role 不正确）”与“未绑定律师资料（Lawyer 记录缺失）”
  - 修复：种子数据/审核通过后创建 Lawyer/更新 role 的链路
- 完善前端错误引导：
  - 403 时明确提示“去认证”并跳转 /lawyer/verification

测试：

- e2e：律师工作台进入、列表加载、接单/拒单/完成最小闭环

---

### Milestone 4（P0/P1）：文书生成专业化（模板 + 导出）

目标：从“纯文本输出”升级为“可下载可打印的专业文书”。

内容建议（分两步）：

- 第一步（可快速落地）：
  - 前端：表单化采集信息 + 预览（HTML 排版）+ 导出 PDF（后端渲染）
  - 后端：引入可靠 PDF 生成依赖（需评估部署环境）
- 第二步（增强）：
  - 支持 Word（docx）模板渲染
  - 支持模板资产管理（可配置/可版本化）

验收：

- 至少 2 种核心文书具备“预览 + 导出 PDF”能力

---

### Milestone 5（P1）：VIP 权益页与购买流程专业化

目标：提升转化、降低购买疑虑。

前端：

- 新增 /vip（或 /membership）权益介绍页：
  - 权益列表、普通 vs VIP 对比、套餐价格、FAQ、风险提示
- 购买流程从 confirm 升级：
  - 独立确认订单页（或增强型购买弹窗）
  - 支付失败重试、余额不足去充值

后端：

- 维持现有 pricing + order 支付契约，必要时补充“订单详情接口”。

---

## 3. 依赖与配置清单

- Redis：
  - 用于验证码 TTL/限流（生产建议强制要求 Redis 可用）。
- 短信服务：
  - 需甲方提供短信服务商账号、签名与模板（阿里云/腾讯云/云片等）。
- 邮箱服务：
  - SMTP 配置或第三方邮件服务（SendGrid/Mailgun/阿里云邮件推送等）。
- 文书 PDF：
  - 需明确部署环境依赖（Windows/Linux、字体、渲染引擎等）。

---

## 4. 回归与验收清单（每个里程碑都必须执行）

- 后端：
  - py -m pytest -q
- 前端：
  - npm run build
  - npm run test:e2e（或增量 e2e）
- 最新回归记录：
  - 2026-01-08：main 合并 PR #18/#19 后，Playwright E2E 全量回归（--workers=1）86 passed
- 关键手工冒烟：
  - 注册/登录
  - 个人中心（VIP、次数包、余额展示）
  - 律师工作台（接单/拒单/完成）
  - 文书生成（预览/导出）

---

## 5. 风险与回滚策略

- 引入短信/邮箱会带来外部依赖与费用：建议先做 DEBUG 下的联调模式，再切换生产配置。
- 文书 PDF 导出依赖可能导致部署失败：先在 CI/容器环境验证，必要时降级为“仅 HTML 预览 + 后续补 PDF”。
- 涉及用户表新增字段需迁移：必须提供 Alembic migration 与 SQLite init_db 兼容策略。

---

## 6. 工时预估（粗粒度）

- M1（短信 + 邮箱验证）：5-8 天
- M2（余额展示 + 充值入口）：2-4 天
- M3（律师工作台链路冒烟修）：1-2 天
- M4（文书专业化第一步）：5-8 天（受依赖影响）
- M5（VIP 权益页 + 购买流程升级）：3-5 天
