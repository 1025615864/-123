# 项目名称：百姓法律助手

## 一、项目概述

### 1.1 背景与目标

- **解决什么问题**：为普通用户提供一站式的法律咨询与法律信息服务，降低获取法律帮助的门槛；同时为律师/律所提供获客、咨询、结算的闭环能力。
- **核心价值**：
  - 用户侧：AI 法律咨询（可选 RAG）+ 法律资讯 + 社区问答 + 文书生成等能力，形成“咨询-学习-行动”的闭环。
  - 运营侧：内容治理、News AI 内容加工、审核与配置管理，具备可运维、可交付能力。
- **目标用户**：
  - 普通公众：有法律问题，需要咨询、学习、文书生成。
  - 律师：希望在线接单、回复咨询、提现结算。
  - 运营/管理员：希望进行内容审核、系统配置、数据导出。

### 1.2 项目范围

- ✅ 包含：
  - 用户注册/登录、个人中心、邮箱/手机验证
  - AI 法律咨询（同步 + SSE 流式）、咨询历史、分享
  - 新闻资讯（列表/详情/收藏/订阅/评论）+ RSS 采集 + News AI 标注与运维
  - 社区论坛（发帖/评论/点赞/收藏/审核/回收站）
  - 律所/律师信息、律师认证、律师咨询预约、律师工作台
  - 支付订单（下单/支付/回调审计）+ VIP/次数包/余额
  - 通知系统 + WebSocket 在线推送
  - 文书生成 + 保存与管理
  - 全局搜索、日历提醒、反馈工单
  - 管理后台（统计/用户/内容/配置/日志/导出）
- ❌ 不包含（当前不作为主线目标）：
  - 复杂的多租户/分账体系
  - 全量法条库的权威对接与自动更新（当前为自建知识库导入）
  - 线下签约、线下律所/律师资质校验的外部系统对接

---

## 二、用户角色

| 角色 | 描述 | 核心权限 |
|------|------|----------|
| 游客 | 未登录用户 | 浏览新闻/论坛、有限试用 AI（按 IP 限制）、部分页面访问 |
| 普通用户 | 已注册用户 | 进行 AI 咨询、发帖评论、收藏订阅、文书生成与保存、创建订单与支付 |
| 律师 | 具备律师角色且认证通过 | 律师工作台、接单/拒单/完成咨询、收入/提现/收款账户管理 |
| 管理员 | 运营/管理人员 | 审核与治理、系统配置、数据导出、查看运维状态与日志 |

---

## 三、功能需求

> 说明：接口以 `/api` 为统一前缀，详细 API 以 Swagger 为准（`/docs`）。以下为需求口径与验收点。

### 3.1 用户与认证模块

#### F001 - 用户注册
- **描述**：用户通过用户名+邮箱+密码注册，并勾选用户协议/隐私政策/AI 免责声明。
- **输入**：`username`、`email`、`password`、`nickname(可选)`、三项同意勾选。
- **流程**：
  1. 填写注册信息并提交
  2. 服务端创建用户并记录协议同意记录
  3. 如邮箱未验证，尝试发送验证邮件（开发环境可返回 token/链接）
- **异常情况**：
  - 用户名/邮箱已存在 → 400
  - 未勾选协议 → 400
- **优先级**：P0

#### F002 - 用户登录
- **描述**：用户名或邮箱 + 密码登录，返回 JWT。
- **输出**：`token.access_token`（注意 token 在 `token` 字段下）。
- **优先级**：P0

#### F003 - 用户资料与安全
- **包含**：获取/更新个人信息、修改密码（需邮箱验证）、邮箱验证请求与确认、短信验证码发送/校验并绑定手机号。
- **优先级**：P0

### 3.2 AI 法律咨询模块

#### F010 - AI 咨询（同步）
- **描述**：用户提交问题，返回 AI 回复与引用（可选）。
- **输入**：`message`、`session_id(可选)`。
- **流程**：
  1. 校验 AI 配置（`OPENAI_API_KEY`）
  2. 游客按 IP 限流/配额；登录用户按配额体系校验
  3. 调用 AI 服务生成回答
  4. 会话与消息落库（consultations/chat_messages）
- **异常情况**：
  - AI 未配置 → 503（`AI_NOT_CONFIGURED`）
  - 配额不足/限流 → 429
- **优先级**：P0

#### F011 - AI 咨询（流式 SSE）
- **描述**：以 SSE 方式增量返回回复内容。
- **输出事件**：`session`、`references`、`content`、`done`。
- **优先级**：P0

#### F012 - 咨询历史与分享
- **描述**：查询历史会话、查看详情、生成分享链接、访问分享页。
- **优先级**：P1

### 3.3 新闻资讯与 News AI

#### F020 - 新闻消费
- **描述**：新闻列表/详情、热门/推荐/置顶、收藏、浏览历史、评论。
- **优先级**：P0

#### F021 - 新闻订阅
- **描述**：订阅分类或关键词，查看订阅流。
- **优先级**：P1

#### F022 - 新闻采集（RSS）与运维
- **描述**：管理员维护 RSS 来源；可手动触发采集；查看采集运行记录。
- **优先级**：P1

#### F023 - News AI 内容加工
- **描述**：对新闻生成摘要/关键词/风险等级等标注；提供运维状态与错误趋势。
- **优先级**：P1

### 3.4 社区论坛与内容治理

#### F030 - 发帖与互动
- **描述**：发帖、评论、点赞、收藏、表情反应。
- **优先级**：P0

#### F031 - 审核与回收站
- **描述**：帖子/评论支持审核状态；支持删除与回收站恢复/永久删除。
- **优先级**：P1

### 3.5 律所/律师与咨询预约

#### F040 - 律所/律师信息
- **描述**：律所/律师列表与详情。
- **优先级**：P1

#### F041 - 律师认证
- **描述**：律师提交认证材料，管理员审核通过后具备律师能力。
- **优先级**：P1

#### F042 - 律师咨询预约（含支付）
- **描述**：用户预约律师咨询，若收费则生成订单并支付；律师侧接单/拒单/完成。
- **优先级**：P1

### 3.6 支付与商业化

#### F050 - 订单创建与支付
- **描述**：创建订单（VIP/次数包/充值/咨询等），支持多支付方式并记录回调事件。
- **优先级**：P0

#### F051 - VIP 与次数包权益
- **描述**：VIP 到期时间、AI/文书生成次数包充值与消耗。
- **优先级**：P1

### 3.7 通知与 WebSocket

#### F060 - 通知中心
- **描述**：通知列表、未读数、批量已读/删除；管理员广播系统通知。
- **优先级**：P1

#### F061 - WebSocket 在线推送
- **描述**：建立 ws 连接（支持 Bearer header 或 query token），推送系统消息。
- **优先级**：P2

### 3.8 文书生成、日历与反馈

#### F070 - 文书生成
- **描述**：生成起诉状/答辩状/和解协议/律师函模板内容；支持保存与列表管理。
- **优先级**：P1

#### F071 - 法律日历提醒
- **描述**：创建/查询/更新/删除提醒事项。
- **优先级**：P2

#### F072 - 反馈工单
- **描述**：用户提交反馈，管理员回复与更新状态。
- **优先级**：P1

---

## 四、非功能需求

| 类别 | 要求 |
|------|------|
| 性能 | 常规接口响应 < 500ms（本地/单实例）；列表接口支持分页 |
| 并发 | 生产可通过多副本部署；需要 Redis 分布式锁避免周期任务重复执行 |
| 安全 | JWT 鉴权、密码哈希存储、CORS 可控、敏感配置/密钥不得入库（SystemConfig 拦截） |
| 稳定性 | AI/News AI 等可选能力在未配置时应降级并给出可理解错误 |
| 审计 | 支付回调事件落库；管理员操作日志可追溯 |
| 可运维 | /health、/health/detailed、/api/system/news-ai/status、/api/system/ai/status（管理员） |

---

## 五、页面清单（前端路由）

| 页面名称 | 路径 | 描述 | 关联功能 |
|----------|------|------|----------|
| 首页 | `/` | 入口与模块导航 | 多模块入口 |
| AI 咨询 | `/chat` | AI 问答（支持流式） | F010/F011 |
| 咨询历史 | `/chat/history` | 历史会话列表与详情 | F012 |
| 论坛列表 | `/forum` | 帖子列表 | F030 |
| 发帖 | `/forum/new` | 发布帖子 | F030 |
| 帖子详情 | `/forum/post/:postId` | 帖子详情/评论互动 | F030/F031 |
| 新闻列表 | `/news` | 新闻列表/筛选 | F020 |
| 新闻详情 | `/news/:newsId` | 新闻详情/评论/收藏 | F020 |
| 专题列表/详情 | `/news/topics`、`/news/topics/:topicId` | 新闻专题 | F020 |
| 律所列表/详情 | `/lawfirm`、`/lawfirm/:firmId` | 律所信息 | F040 |
| 律师详情 | `/lawfirm/lawyers/:lawyerId` | 律师信息 | F040 |
| 搜索 | `/search` | 全局搜索 | F0xx |
| 通知中心 | `/notifications` | 通知列表/未读 | F060 |
| 订单中心 | `/orders` | 订单/支付相关入口 | F050 |
| 文书生成 | `/documents` | 生成与保存文书 | F070 |
| 日历 | `/calendar` | 提醒事项 | F071 |
| 反馈 | `/feedback` | 反馈工单 | F072 |
| 登录/注册 | `/login`、`/register` | 认证 | F001/F002 |
| 个人中心 | `/profile` | 用户信息与设置 | F003 |
| 管理后台 | `/admin/*` | 运营与配置 | 管理功能 |

---

## 六、原型/设计稿链接

- 当前以实现页面为准（见 `frontend/src/App.tsx` 路由定义）。
- 若后续补充设计稿，可在此处添加链接（Figma/蓝湖等）。
