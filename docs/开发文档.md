# 百姓法律助手 - 开发文档

## 1. 项目概述

**项目名称**：百姓法律助手  
**项目描述**：一个面向普通百姓的法律咨询服务平台，提供 AI 智能法律咨询、法律新闻资讯、用户交流论坛、律师咨询所等功能。

## 2. 技术架构

### 2.1 后端技术栈

- **核心框架**：FastAPI (Python 3.10+)
- **数据库**：SQLite (开发) / PostgreSQL (生产)
- **ORM**：SQLAlchemy
- **AI 引擎**：
  - LangChain (AI 对话框架)
  - OpenAI API / 本地大模型 (可配置)
  - ChromaDB (向量数据库，存储法律条文知识库)
- **认证**：JWT Token
- **缓存**：Redis (可选)

### 2.2 前端技术栈

- **框架**：React 19 + TypeScript 5.9
- **构建工具**：Vite 7
- **样式**：TailwindCSS 4
- **路由**：React Router 7
- **数据获取**：TanStack Query 5 + Axios
- **图标**：Lucide React
- **UI 组件**：自定义组件库 (Button, Card, Modal, Input 等)

### 2.3 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      前端 (React)                            │
├─────────────────────────────────────────────────────────────┤
│  首页  │  用户中心  │  论坛  │  新闻  │  咨询所  │  AI助手   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (FastAPI)                     │
├──────────┬──────────┬──────────┬──────────┬─────────────────┤
│ 用户模块 │ 论坛模块 │ 新闻模块 │ 咨询模块 │   AI助手模块    │
└──────────┴──────────┴──────────┴──────────┴─────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
    ┌──────────┐       ┌──────────┐       ┌──────────┐
    │  SQLite  │       │ ChromaDB │       │  LLM API │
    │ 业务数据  │       │ 法律知识库│       │  大模型   │
    └──────────┘       └──────────┘       └──────────┘
```

## 3. 功能模块设计

### 3.1 用户模块

| 功能     | 描述                   |
| -------- | ---------------------- |
| 用户注册 | 邮箱/手机号注册        |
| 用户登录 | 账号密码/验证码登录    |
| 个人中心 | 个人信息管理、头像上传 |
| 咨询历史 | 查看历史咨询记录       |
| 收藏管理 | 收藏的文章、帖子       |

### 3.2 论坛模块

| 功能     | 描述                           |
| -------- | ------------------------------ |
| 板块分类 | 劳动纠纷、婚姻家庭、合同纠纷等 |
| 发帖     | 用户发布问题或经验分享         |
| 评论回复 | 帖子评论和楼中楼回复           |
| 点赞收藏 | 帖子点赞和收藏功能             |
| 热门排行 | 热门帖子推荐                   |

### 3.3 新闻展示模块

| 功能     | 描述             |
| -------- | ---------------- |
| 新闻列表 | 法律新闻资讯列表 |
| 新闻详情 | 新闻内容详情页   |
| 分类筛选 | 按法律领域分类   |
| 搜索功能 | 关键词搜索新闻   |

### 3.4 法律咨询所模块

| 功能     | 描述                 |
| -------- | -------------------- |
| 律师列表 | 入驻律师展示         |
| 律师详情 | 律师资质、专长、评价 |
| 预约咨询 | 在线预约律师         |
| 在线咨询 | 文字/视频咨询        |
| 评价系统 | 咨询后评价           |

### 3.5 AI 法律咨询小助手 (核心)

| 功能     | 描述                         |
| -------- | ---------------------------- |
| 智能问答 | 基于法律知识库的智能对话     |
| 法条引用 | 回答时引用具体法律条文       |
| 案例参考 | 相关案例推荐                 |
| 多轮对话 | 支持上下文连续对话           |
| 咨询记录 | 保存历史对话记录             |
| 导出功能 | 导出咨询记录为 PDF           |
| 风险评估 | 根据用户情况评估法律风险等级 |
| 智能追问 | 自动识别关键信息并追问确认   |

### 3.6 知识库管理模块 (新增)

| 功能     | 描述                   |
| -------- | ---------------------- |
| 法条管理 | 添加/编辑/删除法律条文 |
| 案例管理 | 添加/编辑/删除典型案例 |
| 法规管理 | 管理法规规章和司法解释 |
| 向量化   | 将知识同步到向量数据库 |
| 分类管理 | 按法律领域分类管理     |
| 咨询模板 | 管理预设问题模板       |

## 4. 数据库设计

### 4.1 用户表 (users)

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    avatar VARCHAR(255),
    role VARCHAR(20) DEFAULT 'user',  -- user/lawyer/admin
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 论坛帖子表 (posts)

```sql
CREATE TABLE posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    view_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    is_top BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.3 评论表 (comments)

```sql
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    post_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    parent_id INTEGER,
    content TEXT NOT NULL,
    like_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.4 新闻表 (news)

```sql
CREATE TABLE news (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    summary VARCHAR(500),
    content TEXT NOT NULL,
    cover_image VARCHAR(255),
    category VARCHAR(50),
    author VARCHAR(50),
    view_count INTEGER DEFAULT 0,
    is_published BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 4.5 律师表 (lawyers)

```sql
CREATE TABLE lawyers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER UNIQUE NOT NULL,
    license_no VARCHAR(50) NOT NULL,
    law_firm VARCHAR(100),
    specialties TEXT,
    experience_years INTEGER,
    introduction TEXT,
    rating DECIMAL(2,1) DEFAULT 5.0,
    consultation_count INTEGER DEFAULT 0,
    is_verified BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.6 咨询记录表 (consultations)

```sql
CREATE TABLE consultations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    session_id VARCHAR(50) NOT NULL,
    title VARCHAR(200),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.7 对话消息表 (chat_messages)

```sql
CREATE TABLE chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    consultation_id INTEGER NOT NULL,
    role VARCHAR(20) NOT NULL,  -- user/assistant
    content TEXT NOT NULL,
    references TEXT,  -- JSON格式存储引用的法条
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (consultation_id) REFERENCES consultations(id)
);
```

## 5. API 接口设计

### 5.1 用户接口

- `POST /api/user/register` - 用户注册
- `POST /api/user/login` - 用户登录
- `GET /api/user/me` - 获取当前用户信息
- `PUT /api/user/me` - 更新用户信息

### 5.2 论坛接口

- `GET /api/forum/posts` - 获取帖子列表
- `POST /api/forum/posts` - 发布帖子
- `GET /api/forum/posts/{id}` - 获取帖子详情
- `POST /api/forum/posts/{id}/comments` - 发表评论

### 5.3 新闻接口

- `GET /api/news` - 获取新闻列表
- `GET /api/news/{id}` - 获取新闻详情

### 5.4 咨询所接口

- `GET /api/lawfirm/firms` - 获取律所列表
- `GET /api/lawfirm/firms/{id}` - 获取律所详情
- `GET /api/lawfirm/lawyers` - 获取律师列表
- `GET /api/lawfirm/lawyers/{id}` - 获取律师详情
- `POST /api/lawfirm/consultations` - 预约咨询

### 5.5 AI 助手接口

- `POST /api/ai/chat` - 发送消息并获取 AI 回复
- `GET /api/ai/consultations` - 获取咨询历史列表
- `GET /api/ai/consultations/{id}` - 获取单次咨询详情

说明：

- `POST /api/ai/chat` 支持通过 `session_id`（请求体字段）继续同一会话；为空则创建新会话。

### 5.6 知识库管理接口 (新增)

- `GET /api/knowledge/laws` - 获取法律知识列表
- `POST /api/knowledge/laws` - 创建法律知识
- `GET /api/knowledge/laws/{id}` - 获取知识详情
- `PUT /api/knowledge/laws/{id}` - 更新法律知识
- `DELETE /api/knowledge/laws/{id}` - 删除法律知识
- `POST /api/knowledge/laws/{id}/vectorize` - 向量化单条知识
- `POST /api/knowledge/laws/batch-vectorize` - 批量向量化
- `POST /api/knowledge/sync-vector-store` - 同步所有未向量化知识
- `GET /api/knowledge/stats` - 获取知识库统计
- `GET /api/knowledge/categories` - 获取分类列表
- `GET /api/knowledge/templates` - 获取咨询模板列表
- `POST /api/knowledge/templates` - 创建咨询模板
- `PUT /api/knowledge/templates/{id}` - 更新咨询模板
- `DELETE /api/knowledge/templates/{id}` - 删除咨询模板

## 6. 项目目录结构

```
百姓助手/
├── .github/
│   └── workflows/
│       └── type-check.yml     # CI/CD 类型检查
├── backend/                       # 后端代码
│   ├── app/
│   │   ├── main.py            # FastAPI 入口
│   │   ├── config.py          # 配置文件
│   │   ├── database.py        # 数据库连接
│   │   ├── models/            # SQLAlchemy 2.0 模型
│   │   │   ├── user.py        # 用户模型
│   │   │   ├── forum.py       # 论坛模型（帖子/评论/点赞/收藏）
│   │   │   ├── news.py        # 新闻模型
│   │   │   ├── lawfirm.py     # 律所/律师/咨询/评价模型
│   │   │   ├── consultation.py # AI 咨询记录模型
│   │   │   └── knowledge.py   # 知识库模型（法条/案例/模板）
│   │   ├── schemas/           # Pydantic 模式
│   │   │   ├── user.py        # 用户相关
│   │   │   ├── forum.py       # 论坛相关
│   │   │   ├── news.py        # 新闻相关
│   │   │   ├── lawfirm.py     # 律所相关
│   │   │   ├── ai.py          # AI 相关
│   │   │   └── knowledge.py   # 知识库相关
│   │   ├── routers/           # API 路由
│   │   │   ├── user.py        # 用户注册/登录/个人中心
│   │   │   ├── forum.py       # 论坛 CRUD
│   │   │   ├── news.py        # 新闻 CRUD
│   │   │   ├── lawfirm.py     # 律所/律师 CRUD
│   │   │   ├── admin.py       # 管理后台统计
│   │   │   ├── upload.py      # 文件上传
│   │   │   ├── ai.py          # AI 咨询
│   │   │   └── knowledge.py   # 知识库管理
│   │   ├── services/          # 业务逻辑层
│   │   │   ├── user_service.py
│   │   │   ├── forum_service.py
│   │   │   ├── news_service.py
│   │   │   ├── lawfirm_service.py
│   │   │   ├── ai_assistant.py # LangChain AI 助手
│   │   │   └── knowledge_service.py # 知识库服务
│   │   └── utils/             # 工具函数
│   │       ├── security.py    # JWT/密码加密
│   │       └── deps.py        # FastAPI 依赖注入
│   ├── knowledge_base/        # 法律知识库
│   │   └── laws/              # 法律条文文档
│   ├── uploads/               # 上传文件存储
│   ├── scripts/               # 工具脚本
│   ├── pyrightconfig.json     # Pyright 配置
│   └── requirements.txt
├── frontend/                      # 前端代码
│   ├── src/
│   │   ├── api/               # API 客户端 (Axios)
│   │   ├── components/        # 通用组件
│   │   │   ├── ui/            # 基础 UI 组件
│   │   │   ├── Layout.tsx     # 前台布局
│   │   │   └── AdminLayout.tsx # 后台布局
│   │   ├── contexts/          # React Context
│   │   ├── hooks/             # 自定义 Hooks
│   │   ├── pages/             # 页面组件
│   │   │   ├── HomePage.tsx
│   │   │   ├── ChatPage.tsx   # AI 咨询（含法条引用展示）
│   │   │   ├── ForumPage.tsx  # 论坛
│   │   │   ├── NewsPage.tsx   # 新闻
│   │   │   ├── LawFirmPage.tsx # 律所
│   │   │   ├── ProfilePage.tsx # 个人中心
│   │   │   └── admin/         # 管理后台页面
│   │   │       ├── KnowledgeManagePage.tsx  # 知识库管理
│   │   │       └── TemplatesManagePage.tsx  # 咨询模板管理
│   │   ├── types/             # TypeScript 类型
│   │   ├── App.tsx            # 路由配置
│   │   └── main.tsx           # 入口文件
│   └── package.json
├── docs/                          # 文档
├── .pre-commit-config.yaml        # Pre-commit 配置
└── docker-compose.yml             # Docker 配置
```

## 7. 开发计划

### 第一阶段：核心功能

1. ✅ 制定开发文档
2. ✅ 开发 AI 法律咨询小助手
3. ✅ 搭建后端基础框架

### 第二阶段：用户系统

4. ✅ 开发用户模块（注册、登录、个人中心）
5. ✅ 实现 JWT 认证

### 第三阶段：内容模块

6. ✅ 开发新闻模块
7. ✅ 开发论坛模块

### 第四阶段：咨询服务

8. ✅ 开发法律咨询所模块
9. ✅ 律师入驻功能

### 第五阶段：前端开发

10. ✅ 前端页面开发
11. ✅ AI 知识库管理系统
12. 🔄 整合测试
13. 部署上线

## 8. 环境配置

### 8.1 环境变量 (.env)

```
# 应用配置
APP_NAME=百姓法律助手
DEBUG=true

# 数据库
# 开发环境默认使用 SQLite（可不配置）。
# 如需切换 PostgreSQL，请填写 postgresql+asyncpg://... 的连接串。
DATABASE_URL=sqlite+aiosqlite:///./data/app.db

# JWT/密钥
# 后端配置中 SECRET_KEY 与 JWT_SECRET_KEY 二选一即可（生产环境建议 >= 32 位随机字符串）。
JWT_SECRET_KEY=your-secret-key-here
# SECRET_KEY=your-secret-key-here

ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# CORS
# 支持逗号分隔：例如 http://localhost:5173,http://localhost:3000
CORS_ALLOW_ORIGINS=http://localhost:5173

# Redis（可选）
REDIS_URL=

# AI（可选）
OPENAI_API_KEY=your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1
AI_MODEL=deepseek-chat

# ChromaDB
CHROMA_PERSIST_DIR=./chroma_db

# 其它
FRONTEND_BASE_URL=http://localhost:5173
TRUSTED_PROXIES=[]
```

### 8.2 本地开发建议

- **后端默认端口**: `8000`
- **前端开发服务器端口**: `5173`（Vite）

建议在 `frontend/.env` 中配置：

```env
VITE_API_BASE_URL=/api
```

开发模式下，前端通过 `frontend/vite.config.ts` 代理：

- **HTTP API**: `/api` -> `http://localhost:8000`
- **WebSocket**: `/ws` -> `ws://localhost:8000`

## 9. 代码质量

### 9.1 类型检查

项目使用 Pyright 进行静态类型检查，确保代码类型安全。

```bash
# 运行类型检查
cd backend
pyright .
```

### 9.2 类型注解规范

- 使用 Python 3.10+ 类型语法（`str | None` 而非 `Optional[str]`）
- SQLAlchemy 模型使用 2.0 风格（`Mapped[...]` 和 `mapped_column`）
- FastAPI 参数使用 `Annotated` 声明
- Pydantic `Config.from_attributes` 需有 `bool` 类型注解

### 9.3 CI/CD

项目配置了 GitHub Actions 工作流，在每次 push/PR 时自动运行类型检查。

配置文件：`.github/workflows/type-check.yml`

### 9.4 Pre-commit 钩子

项目配置了 pre-commit 钩子，在提交前自动检查代码质量。

```bash
# 安装 pre-commit
pip install pre-commit

# 安装钩子
pre-commit install

# 手动运行所有检查
pre-commit run --all-files
```

配置文件：`.pre-commit-config.yaml`

---

## 10. 后续迭代建议

### 10.1 高优先级（建议近期完成）

| 功能             | 描述                                       | 预计工作量 |
| ---------------- | ------------------------------------------ | ---------- |
| **单元测试**     | 为核心服务层添加 pytest 测试用例           | 2-3 天     |
| **API 错误处理** | 统一异常处理中间件，标准化错误响应格式     | 1 天       |
| **数据验证增强** | 添加更严格的输入验证（手机号、邮箱格式等） | 0.5 天     |
| **日志系统**     | 配置结构化日志，便于生产环境排查问题       | 0.5 天     |
| **环境配置**     | 区分开发/测试/生产环境配置                 | 0.5 天     |

### 10.2 中优先级（功能增强）

| 功能             | 描述                             | 预计工作量 |
| ---------------- | -------------------------------- | ---------- |
| **搜索优化**     | 论坛/新闻全文搜索，支持分词      | 2 天       |
| **消息通知**     | 评论回复、咨询状态变更通知       | 2 天       |
| **图片上传优化** | 图片压缩、缩略图生成、CDN 集成   | 1 天       |
| **用户行为分析** | 浏览记录、推荐算法基础           | 2 天       |
| **导出功能**     | AI 咨询记录导出为 PDF            | 1 天       |
| **评论点赞**     | 完善评论点赞功能（前端已有接口） | 0.5 天     |

### 10.3 低优先级（长期规划）

| 功能                | 描述                                    | 预计工作量 |
| ------------------- | --------------------------------------- | ---------- |
| **PostgreSQL 迁移** | 从 SQLite 迁移到 PostgreSQL（生产环境） | 1 天       |
| **Redis 缓存**      | 热点数据缓存，提升性能                  | 1 天       |
| **WebSocket**       | AI 对话实时流式输出                     | 2 天       |
| **OAuth 登录**      | 微信/支付宝第三方登录                   | 2 天       |
| **多语言支持**      | i18n 国际化                             | 3 天       |
| **移动端适配**      | 响应式优化或 React Native 版本          | 5+ 天      |

### 10.4 技术债务清理

| 项目             | 描述                                       |
| ---------------- | ------------------------------------------ |
| **前端类型完善** | 补充 TypeScript 类型定义，减少 `any` 使用  |
| **API 文档**     | 完善 OpenAPI 描述，添加请求/响应示例       |
| **代码复用**     | 抽取前端通用 hooks（分页、表单、API 调用） |
| **性能优化**     | 前端懒加载、代码分割、图片懒加载           |
| **安全加固**     | CSRF 防护、Rate Limiting、SQL 注入检查     |

### 10.5 部署建议

```bash
# 开发环境
cd backend
python -m uvicorn app.main:app --reload --port 8000

cd frontend
npm run dev

# 生产环境（推荐）
# 1. 使用 Docker Compose
docker compose up -d --build

# 2. 或使用 Nginx + Gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker

# 3. 前端构建
cd frontend
npm run build
# 将 dist 目录部署到 Nginx/CDN
```

### 10.6 监控建议

- **应用监控**: Sentry（错误追踪）
- **性能监控**: Prometheus + Grafana
- **日志收集**: ELK Stack 或 Loki
- **健康检查**: `/health` 端点已实现

---

**文档版本**: v1.3  
**更新日期**: 2025-12-20

### 更新日志

**v1.3 (2025-12-20)**

- 新增知识库管理模块（法条/案例/法规/司法解释 CRUD）
- 新增咨询模板管理功能
- 增强 AI 助手：法条精准引用、风险评估、智能追问
- 新增管理后台知识库管理页面
- 优化 AI 咨询页面，支持法条引用展示
