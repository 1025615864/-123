name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.3.0). Required if manual dispatch."
        required: false
        default: ""
      push_images:
        description: "PUSH_IMAGES=1 to publish Docker images to GHCR (requires packages permission)."
        required: false
        default: "0"

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag
        id: vars
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          REF_TAG: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
        run: |
          set -euo pipefail
          TAG="${REF_TAG:-}"
          if [ -z "$TAG" ]; then TAG="${INPUT_TAG:-}"; fi
          if [ -z "$TAG" ]; then
            echo "tag is required (push a tag or provide workflow_dispatch input)" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Resolve publish flags
        id: flags
        env:
          INPUT_PUSH_IMAGES: ${{ github.event.inputs.push_images }}
          SECRET_GHCR_PUBLISH: ${{ secrets.GHCR_PUBLISH }}
        run: |
          set -euo pipefail
          PUSH_IMAGES="0"
          if [ "${INPUT_PUSH_IMAGES:-0}" = "1" ]; then PUSH_IMAGES="1"; fi
          if [ "${SECRET_GHCR_PUBLISH:-0}" = "1" ]; then PUSH_IMAGES="1"; fi
          echo "push_images=$PUSH_IMAGES" >> "$GITHUB_OUTPUT"

      - name: Extract release notes from CHANGELOG
        id: notes
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail
          FILE="docs/CHANGELOG.md"
          if [ ! -f "$FILE" ]; then
            echo "CHANGELOG not found: $FILE" >&2
            exit 1
          fi

          if grep -q "^## \\[$TAG\\]" "$FILE"; then
            awk -v tag="$TAG" '
              BEGIN {p=0}
              $0 ~ "^## \\[" tag "\\]" {p=1; next}
              $0 ~ "^## \\[" && p==1 {exit}
              p==1 {print}
            ' "$FILE" > /tmp/release_notes.md
          else
            awk '
              BEGIN {p=0}
              $0 ~ "^## \\[Unreleased\\]" {p=1; next}
              $0 ~ "^## \\[" && p==1 {exit}
              p==1 {print}
            ' "$FILE" > /tmp/release_notes.md
          fi

          # remove leading empty lines
          sed -i '1{/^$/d;}' /tmp/release_notes.md

          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          cat /tmp/release_notes.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        env:
          CI: "1"
        run: |
          set -euo pipefail
          npm --prefix frontend ci
          npm --prefix frontend run build

      - name: Package frontend dist
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          (cd frontend && zip -r "../dist/frontend-dist-${TAG}.zip" dist)

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Package Helm chart
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          helm dependency build ./helm/baixing-assistant
          helm package ./helm/baixing-assistant --destination dist

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        if: ${{ steps.flags.outputs.push_images == '1' }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        if: ${{ steps.flags.outputs.push_images == '1' }}
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image names
        id: img
        if: ${{ steps.flags.outputs.push_images == '1' }}
        env:
          TAG: ${{ steps.vars.outputs.tag }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          OWNER=$(echo "$REPO" | cut -d/ -f1)
          echo "backend=ghcr.io/${OWNER}/baixing-backend:${TAG}" >> "$GITHUB_OUTPUT"
          echo "backend_latest=ghcr.io/${OWNER}/baixing-backend:latest" >> "$GITHUB_OUTPUT"
          echo "frontend=ghcr.io/${OWNER}/baixing-frontend:${TAG}" >> "$GITHUB_OUTPUT"
          echo "frontend_latest=ghcr.io/${OWNER}/baixing-frontend:latest" >> "$GITHUB_OUTPUT"

      - name: Build & push backend image
        uses: docker/build-push-action@v5
        if: ${{ steps.flags.outputs.push_images == '1' }}
        with:
          context: ./backend
          push: true
          tags: |
            ${{ steps.img.outputs.backend }}
            ${{ steps.img.outputs.backend_latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push frontend image
        uses: docker/build-push-action@v5
        if: ${{ steps.flags.outputs.push_images == '1' }}
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ steps.img.outputs.frontend }}
            ${{ steps.img.outputs.frontend_latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.tag }}
          body: ${{ steps.notes.outputs.notes }}
          files: |
            dist/frontend-dist-${{ steps.vars.outputs.tag }}.zip
            dist/*.tgz
          draft: false
          prerelease: false
