name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Helm Chart æ ¡éªŒï¼ˆç¡®ä¿ templates å¯æ¸²æŸ“ã€YAML åˆæ³•ï¼‰
  helm-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Helm repo add (bitnami)
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Helm dependency build
        run: |
          helm dependency build ./helm/baixing-assistant

      - name: Helm lint
        run: |
          helm lint ./helm/baixing-assistant

      - name: Helm template (render)
        run: |
          set -euo pipefail
          helm template test ./helm/baixing-assistant \
            --namespace baixing \
            --set-string image.backend.repository=example/baixing-backend \
            --set-string image.backend.tag=ci \
            --set-string image.frontend.repository=example/baixing-frontend \
            --set-string image.frontend.tag=ci \
            --set-string backend.secret.DATABASE_URL=postgresql+asyncpg://user:pass@postgres:5432/baixing_law \
            --set-string backend.secret.JWT_SECRET_KEY=dummy_jwt_secret_key \
            --set-string backend.secret.PAYMENT_WEBHOOK_SECRET=dummy_payment_webhook_secret \
            --set-string backend.secret.REDIS_URL=redis://redis:6379/0 \
            --set-string backend.secret.OPENAI_API_KEY=dummy_openai_api_key \
            --set-string ingress.host=example.com \
            > /tmp/helm-rendered.yaml

      - name: Helm template (render) - subcharts enabled
        run: |
          set -euo pipefail
          helm template test-subcharts ./helm/baixing-assistant \
            --namespace baixing \
            --set redis.enabled=true \
            --set postgresql.enabled=true \
            --set-string image.backend.repository=example/baixing-backend \
            --set-string image.backend.tag=ci \
            --set-string image.frontend.repository=example/baixing-frontend \
            --set-string image.frontend.tag=ci \
            --set-string backend.secret.DATABASE_URL=postgresql+asyncpg://user:pass@test-subcharts-postgresql:5432/baixing_law \
            --set-string backend.secret.JWT_SECRET_KEY=dummy_jwt_secret_key \
            --set-string backend.secret.PAYMENT_WEBHOOK_SECRET=dummy_payment_webhook_secret \
            --set-string backend.secret.REDIS_URL=redis://:pass@test-subcharts-redis-master:6379/0 \
            --set-string backend.secret.OPENAI_API_KEY=dummy_openai_api_key \
            --set-string ingress.host=example.com \
            > /tmp/helm-rendered-subcharts.yaml

      - name: Helm template (render) - externalSecret enabled
        run: |
          set -euo pipefail
          helm template test-externalsecret ./helm/baixing-assistant \
            --namespace baixing \
            --set-string image.backend.repository=example/baixing-backend \
            --set-string image.backend.tag=ci \
            --set-string image.frontend.repository=example/baixing-frontend \
            --set-string image.frontend.tag=ci \
            --set-string backend.externalSecret.enabled=true \
            --set-string backend.externalSecret.secretStoreRef.name=dummy \
            --set-string backend.externalSecret.secretStoreRef.kind=SecretStore \
            --set-string backend.externalSecret.remoteRefs.DATABASE_URL=dummy_database_url \
            --set-string backend.externalSecret.remoteRefs.JWT_SECRET_KEY=dummy_jwt_secret_key \
            --set-string backend.externalSecret.remoteRefs.PAYMENT_WEBHOOK_SECRET=dummy_payment_webhook_secret \
            --set-string backend.externalSecret.remoteRefs.REDIS_URL=dummy_redis_url \
            --set-string backend.externalSecret.remoteRefs.OPENAI_API_KEY=dummy_openai_api_key \
            --set-string ingress.host=example.com \
            > /tmp/helm-rendered-externalsecret.yaml

  # åŽç«¯æµ‹è¯•
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key
        run: pytest tests/ -v --tb=short

  # å‰ç«¯æž„å»º
  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

  # Playwright E2E (minimal documents closed-loop)
  playwright-documents-e2e:
    needs: [backend-test, frontend-build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare backend data dir
        run: |
          mkdir -p backend/data

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright (chromium)
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Run documents E2E
        working-directory: ./frontend
        env:
          DEBUG: "1"
          JWT_SECRET_KEY: "test-secret-key-change-me-32chars-minimum"
          PAYMENT_WEBHOOK_SECRET: "test-payment-webhook-secret"
          E2E_DATABASE_URL: "sqlite+aiosqlite:////tmp/e2e_playwright.db"
        run: npm run test:e2e -- --grep "documents:"

  # Dockeræž„å»ºï¼ˆä»…mainåˆ†æ”¯ï¼‰
  docker-build:
    needs: [backend-test, frontend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: baixing-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: baixing-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: |
          pip install ruff mypy

      - name: Run Ruff (Python linter)
        run: |
          ruff check backend/app --ignore E501 || echo "ruff check failed (ignored)"
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install ESLint
        working-directory: ./frontend
        run: |
          if node -e "const p=require('./package.json'); const deps={...(p.dependencies||{}),...(p.devDependencies||{})}; process.exit(deps.eslint?0:1)"; then
            npm ci
          else
            echo "eslint not configured; skipping npm ci"
          fi

      - name: Run ESLint
        working-directory: ./frontend
        run: |
          if node -e "const p=require('./package.json'); const deps={...(p.dependencies||{}),...(p.devDependencies||{})}; process.exit(deps.eslint?0:1)"; then
            npx eslint src --ext .ts,.tsx --max-warnings 50 || echo "eslint failed (ignored)"
          else
            echo "eslint not configured; skipping eslint"
          fi
        continue-on-error: true

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "0"

  # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒï¼ˆéœ€è¦æ‰‹åŠ¨è§¦å‘ï¼‰
  deploy-production:
    needs: [backend-test, frontend-build, docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ðŸš€ Ready to deploy to production"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"

      # ä»¥ä¸‹æ­¥éª¤éœ€è¦æ ¹æ®å®žé™…éƒ¨ç½²ç›®æ ‡é…ç½®
      # - name: Deploy to server
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_KEY }}
      #     script: |
      #       cd /app/baixing-law
      #       git pull origin main
      #       docker-compose up -d --build

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Post-deploy smoke hint
        run: |
          echo "## Post Deploy Smoke" >> $GITHUB_STEP_SUMMARY
          echo "After production deploy, run workflow: .github/workflows/post-deploy-smoke.yml" >> $GITHUB_STEP_SUMMARY
          echo "Required secrets: BASE_URL, ADMIN_TOKEN" >> $GITHUB_STEP_SUMMARY

  required-checks:
    runs-on: ubuntu-latest
    needs:
      [helm-validate, backend-test, frontend-build, playwright-documents-e2e]
    if: always()
    steps:
      - name: Verify required jobs
        run: |
          echo "helm-validate=${{ needs.helm-validate.result }}"
          echo "backend-test=${{ needs.backend-test.result }}"
          echo "frontend-build=${{ needs.frontend-build.result }}"
          echo "playwright-documents-e2e=${{ needs.playwright-documents-e2e.result }}"
          test "${{ needs.helm-validate.result }}" = "success"
          test "${{ needs.backend-test.result }}" = "success"
          test "${{ needs.frontend-build.result }}" = "success"
          test "${{ needs.playwright-documents-e2e.result }}" = "success"
