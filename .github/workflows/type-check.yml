name: Type Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  pyright:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libatomic1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyright
          pip install -r backend/requirements.txt

      - name: Run Pyright
        run: |
          pyright -p pyrightconfig.json --outputjson > pyright.json || true
          python - <<'PY'
          import json
          import os
          import sys

          path = "pyright.json"
          if not os.path.exists(path):
              print("::error::pyright.json not generated (pyright may have crashed)")
              sys.exit(1)

          with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)

          diags = data.get("generalDiagnostics") or []
          has_error = False

          # Limit annotations to avoid spamming.
          for d in diags[:200]:
              severity = (d.get("severity") or "error").lower()
              level = "error" if severity == "error" else "warning"
              if level == "error":
                  has_error = True

              file = d.get("file") or "pyright"
              rng = d.get("range") or {}
              start = rng.get("start") or {}
              line = (start.get("line") or 0) + 1
              col = (start.get("character") or 0) + 1
              msg = (d.get("message") or "").replace("\n", " ")

              print(f"::{level} file={file},line={line},col={col}::{msg}")

          print(f"Total diagnostics: {len(diags)}")
          sys.exit(1 if has_error else 0)
          PY
